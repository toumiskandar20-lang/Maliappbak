<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ */
window.register = async function () {
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("password").value;
  const pass2 = document.getElementById("password2").value;
  const invite = document.getElementById("invite").value.trim();

  if (!phone || !email || !pass || !pass2) {
    alert("âŒ ÙƒÙ„ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©");
    return;
  }
  if (pass.length < 6) {
    alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ù‚Ù„ Ù…Ù† 6 Ø£Ø­Ø±Ù");
    return;
  }
  if (pass !== pass2) {
    alert("âŒ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");
    return;
  }

  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, pass);
    const uid = userCred.user.uid;

    // Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø®Ø§Øµ
    const myInvite = Math.random().toString(36).substring(2,8);

    await setDoc(doc(db, "users", uid), {
      phone,
      email,
      balance: 0,
      level: 1,
      inviteCode: myInvite,
      invitedBy: invite || null,
      createdAt: new Date()
    });

    showApp(myInvite);
  } catch (e) {
    alert("âŒ " + e.message);
  }
};

/* ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
window.login = async function () {
  const email = document.getElementById("emailLogin").value.trim();
  const pass = document.getElementById("passwordLogin").value;

  try {
    const userCred = await signInWithEmailAndPassword(auth, email, pass);
    const uid = userCred.user.uid;

    const snap = await getDoc(doc(db, "users", uid));
    showApp(snap.data().inviteCode);
  } catch (e) {
    alert("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©");
  }
};

function showApp(inviteCode) {
  document.getElementById("auth").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("inviteLink").innerText =
    location.origin + "/?ref=" + inviteCode;
}
</script>

<style>
body{
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.box{
  background:#fff;
  width:340px;
  padding:25px;
  border-radius:15px;
  box-shadow:0 20px 40px rgba(0,0,0,.3);
}
h2{margin-bottom:15px}
input,button{
  width:100%;
  padding:11px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  background:#2c5364;
  color:#fff;
  font-size:16px;
  border:none;
}
.switch{
  color:#2575fc;
  cursor:pointer;
  font-size:14px;
}
</style>
</head>

<body>

<div class="box" id="auth">
  <h2>MaliApp</h2>

  <!-- ØªØ³Ø¬ÙŠÙ„ -->
  <div id="registerBox">
    <input id="phone" placeholder="ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input id="email" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input id="password" type="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <input id="password2" type="password" placeholder="ğŸ”’ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <input id="invite" placeholder="ğŸ Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <p class="switch" onclick="toggle()">Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨</p>
  </div>

  <!-- Ø¯Ø®ÙˆÙ„ -->
  <div id="loginBox" style="display:none">
    <input id="emailLogin" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input id="passwordLogin" type="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
    <p class="switch" onclick="toggle()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</p>
  </div>
</div>

<div class="box" id="app" style="display:none">
  <h2>ğŸ‰ Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ</h2>
  <p>Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØªÙƒ:</p>
  <p id="inviteLink" style="word-break:break-all;color:#2575fc"></p>
</div>

<script>
function toggle(){
  registerBox.style.display =
    registerBox.style.display === "none" ? "block" : "none";
  loginBox.style.display =
    loginBox.style.display === "none" ? "block" : "none";
}
</script>

</body>
</html>
