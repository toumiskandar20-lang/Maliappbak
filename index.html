<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body{margin:0;font-family:Arial;background:#111;color:#fff;}
.box{max-width:420px;margin:25px auto;background:#222;border-radius:16px;padding:20px;}
input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;}
button{background:#00c853;font-weight:bold;cursor:pointer;}
.task{background:#333;padding:12px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;}
.hidden{display:none;}
  .match-card{
  background: linear-gradient(145deg,#1e1e1e,#2a2a2a);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.4);
}

.match-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.team{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:bold;
}

.team i{
  font-size:20px;
  color:#00e676;
}

.vs{
  font-size:13px;
  opacity:.7;
}

.match-time{
  font-size:12px;
  background:#111;
  padding:4px 8px;
  border-radius:6px;
  opacity:.8;
}

.bet-buttons{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:10px;
}

.bet-btn{
  background:#111;
  border:1px solid #333;
  border-radius:10px;
  padding:10px;
  font-size:16px;
  font-weight:bold;
  color:#fff;
  transition:.2s;
}

.bet-btn:hover{
  background:#00c853;
  color:#000;
}

.bet-btn:disabled{
  opacity:.4;
  cursor:not-allowed;
}
  .bet-btn.selected{
  background:#00e676;
  color:#000;
}
</style>
</head>
<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="openRegister()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- REGISTER -->
<div class="box hidden" id="registerBox">
  <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <input id="regEmail" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="regPhone" type="tel" placeholder="ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="regPassword" type="password" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regConfirm" type="password" placeholder="ğŸ”‘ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="submitRegister()">âœ… ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="backToLogin()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>ğŸ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

  <h3>âš½ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
  <div id="matchesBox"></div>
</div>

<script type="module">
/* ================= IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  query,
  where,
  serverTimestamp,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= GLOBAL ================= */
let userData = {};
let matches = [];

/* ================= LEVELS ================= */
const LEVELS = {
  1: { reward: 0.5 },
  2: { reward: 1.5 },
  3: { reward: 3 }
};

/* ================= UI ================= */
function updateUI(){
  balance.innerText = userData.balance ?? 0;
  level.innerText = userData.level ?? 1;
}

/* ================= AUTH ================= */
window.openRegister = ()=>{
  authBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
};

window.backToLogin = ()=>{
  registerBox.classList.add("hidden");
  authBox.classList.remove("hidden");
};

window.submitRegister = async ()=>{
  const email = regEmail.value.trim();
  const phone = regPhone.value.trim();
  const pass = regPassword.value;
  const confirm = regConfirm.value;

  if(!email || !phone || !pass || pass !== confirm){
    alert("âŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth,email,pass);

  await setDoc(doc(db,"users",cred.user.uid),{
    email,
    phone,
    balance: 1000,
    level: 1,
    createdAt: serverTimestamp()
  });

  registerBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

/* ================= AUTH STATE ================= */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  userData = snap.data();

  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");

  updateUI();
  await fetchMatches();
});

/* ================= MATCHES ================= */
async function fetchMatches(){
  matchesBox.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª...";
  matches = [];

  const q = query(collection(db,"matches"));
  const snap = await getDocs(q);

  snap.forEach(docu=>{
    const d = docu.data();
    matches.push({
      id: docu.id,
      teamA: d.teamA,
      teamB: d.teamB,
      startTime: d.startTime.toDate(),
      endTime: d.endTime.toDate(),
      result: d.result ?? null,
      settled: d.settled ?? false
    });
  });

  loadMatches();

  // ğŸ”¥ ğŸ”¥ ğŸ”¥ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ù‡Ù…
  matches.forEach(match=>{
    if(match.result && !match.settled){
      settleMatch(match);
    }
  });
}
function loadMatches(){
  matchesBox.innerHTML = "";

  if(matches.length === 0){
    matchesBox.innerHTML = "<p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª</p>";
    return;
  }

  const now = new Date();

  matches.forEach(m=>{
    const canBet = now < m.startTime;

    matchesBox.innerHTML += `
      <div class="match-card">
        <div class="match-header">
          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamA}
          </div>

          <span class="vs">VS</span>

          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamB}
          </div>
        </div>

        <div class="match-time">
          ğŸ•’ ${m.startTime.toLocaleString()}
        </div>

        <div class="bet-buttons">
          <button class="bet-btn" ${canBet?"":"disabled"} onclick="placeBet('${m.id}','1')">1</button>
          <button class="bet-btn" ${canBet?"":"disabled"} onclick="placeBet('${m.id}','X')">X</button>
          <button class="bet-btn" ${canBet?"":"disabled"} onclick="placeBet('${m.id}','2')">2</button>
        </div>
      </div>
    `;
  });
}

/* ================= BET ================= */
window.placeBet = async (matchId, choice)=>{
  try{
    const user = auth.currentUser;
    if(!user) return alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");

    const betRef = doc(db,"bets",`${user.uid}_${matchId}`);
    const snap = await getDoc(betRef);

    if(snap.exists()){
      alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙƒÙ‡Ù†");
      return;
    }

    await setDoc(betRef,{
      userId: user.uid,
      matchId,
      choice,
      settled: false,
      createdAt: serverTimestamp()
    });
event.target.classList.add("selected");
    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙƒÙ‡Ù†: " + choice);

  }catch(e){
    console.error(e);
    alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ®Ø²ÙŠÙ†");
  }
};

/* ================= SETTLE MATCH ================= */
async function settleMatch(match){
  const betsQ = query(
    collection(db,"bets"),
    where("matchId","==",match.id),
    where("settled","==",false)
  );

  const betsSnap = await getDocs(betsQ);

  for(const betDoc of betsSnap.docs){
    const bet = betDoc.data();

    if(bet.choice === match.result){
      const userRef = doc(db,"users",bet.userId);
      const userSnap = await getDoc(userRef);

      if(userSnap.exists()){
        const lvl = userSnap.data().level || 1;
        const reward = LEVELS[lvl].reward;

        await updateDoc(userRef,{
          balance: (userSnap.data().balance || 0) + reward
        });
      }
    }

    await updateDoc(betDoc.ref,{ settled:true });
  }

  await updateDoc(doc(db,"matches",match.id),{ settled:true });
  console.log("âœ… ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:",match.id);
}

/* ================= LOGOUT ================= */
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};
</script>

</body>
</html>
