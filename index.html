<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  arrayUnion
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentTask = null;
let taskTimer = null;

// ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨
window.register = async function () {
  const phone = phoneInput.value;
  const email = emailInput.value;
  const pass = passInput.value;
  const pass2 = pass2Input.value;
  const invite = inviteInput.value || "none";

  if (!phone || !email || !pass || !pass2) {
    alert("Ø¹Ù…Ø± Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„ÙƒÙ„");
    return;
  }
  if (pass !== pass2) {
    alert("ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");
    return;
  }

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const uid = cred.user.uid;

    const myInvite = Math.random().toString(36).substring(2, 8);

    await setDoc(doc(db, "users", uid), {
      phone,
      email,
      balance: 0,
      level: 1,
      team: [],
      inviteCode: myInvite,
      invitedBy: invite,
      createdAt: Date.now()
    });

    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
  } catch (e) {
    alert(e.message);
  }
};

// ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
window.login = async function () {
  try {
    await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
  } catch (e) {
    alert(e.message);
  }
};

// ğŸ”„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
onAuthStateChanged(auth, async user => {
  if (!user) return;
  authBox.style.display = "none";
  appBox.style.display = "block";

  const snap = await getDoc(doc(db, "users", user.uid));
  const data = snap.data();

  balance.innerText = data.balance;
  level.innerText = data.level;
  inviteLink.innerText = location.origin + "?ref=" + data.inviteCode;
});

// ğŸ§  Ø§Ù„Ù…Ù‡Ø§Ù…
window.startTask = function (id) {
  if (currentTask) {
    alert("âš ï¸ ØªÙˆØ¬Ø¯ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„");
    return;
  }

  currentTask = id;
  let time = 30;
  taskStatus.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°: 30 Ø«Ø§Ù†ÙŠØ©";

  taskTimer = setInterval(() => {
    time--;
    taskStatus.innerText = "â³ " + time + " Ø«Ø§Ù†ÙŠØ©";

    if (time <= 0) {
      clearInterval(taskTimer);
      finishTask();
    }
  }, 1000);
};

async function finishTask() {
  const user = auth.currentUser;
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  const data = snap.data();

  await updateDoc(ref, {
    balance: data.balance + 10
  });

  balance.innerText = data.balance + 10;
  taskStatus.innerText = "âœ… ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø© +10 Ù…Ø§Ù„ÙŠ";
  currentTask = null;
}

// ğŸ’° Ø³Ø­Ø¨ Ø±Ø§ØªØ¨
window.withdraw = async function () {
  const amount = Number(withdrawAmount.value);
  const user = auth.currentUser;
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  if (amount <= 0 || amount > snap.data().balance) {
    alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");
    return;
  }

  await updateDoc(ref, {
    balance: snap.data().balance - amount
  });

  balance.innerText = snap.data().balance - amount;
  alert("ğŸ’¼ ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ù†Ø¬Ø§Ø­");
};
</script>

<style>
body {
  font-family: Arial;
  background: linear-gradient(135deg,#6a11cb,#2575fc);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.box {
  background:#fff;
  width:360px;
  padding:20px;
  border-radius:14px;
  box-shadow:0 15px 35px rgba(0,0,0,.3);
}
input,button {
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
}
button {
  background:#2575fc;
  color:#fff;
  border:none;
  font-size:16px;
}
.task {
  background:#f3f3f3;
  padding:10px;
  margin:5px 0;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="box" id="authBox">
  <h2>MaliApp ğŸ”</h2>
  <input id="phoneInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="passInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="pass2Input" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="inviteInput" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="box" id="appBox" style="display:none">
  <h2>ğŸ‰ Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ</h2>
  <p>Ø§Ù„Ø±ØµÙŠØ¯: <b id="balance">0</b> Ù…Ø§Ù„ÙŠ</p>
  <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <b id="level">1</b></p>
  <p>Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØªÙƒ:</p>
  <small id="inviteLink"></small>

  <h3>Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</h3>
  <div class="task"><button onclick="startTask(1)">Ù…Ù‡Ù…Ø© 1</button></div>
  <div class="task"><button onclick="startTask(2)">Ù…Ù‡Ù…Ø© 2</button></div>
  <div class="task"><button onclick="startTask(3)">Ù…Ù‡Ù…Ø© 3</button></div>
  <div class="task"><button onclick="startTask(4)">Ù…Ù‡Ù…Ø© 4</button></div>
  <div class="task"><button onclick="startTask(5)">Ù…Ù‡Ù…Ø© 5</button></div>

  <p id="taskStatus"></p>

  <h3>ğŸ’¼ Ø³Ø­Ø¨ Ø±Ø§ØªØ¨</h3>
  <input id="withdrawAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="withdraw()">Ø³Ø­Ø¨</button>
</div>

</body>
</html>
