<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ğŸ” Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Ø¹Ù†Ø§ØµØ± */
const authBox = document.getElementById("auth");
const appBox = document.getElementById("app");
const statusText = document.getElementById("status");

let currentTaskRunning = false;

/* ğŸ”¹ ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ */
window.register = async () => {
  const email = emailInput.value.trim();
  const pass = passInput.value.trim();
  const invite = inviteInput.value.trim();

  if (!email || !pass) return alert("âŒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø¹Ø·ÙŠØ§Øª");

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const uid = cred.user.uid;

    const referralCode = uid.substring(0, 6);

    await setDoc(doc(db, "users", uid), {
      email,
      balance: 0,
      level: 1,
      teamCount: 0,
      referralCode,
      invitedBy: invite || null,
      lastTasks: {},
      createdAt: serverTimestamp()
    });

    statusText.innerText = "âœ… Ø­Ø³Ø§Ø¨Ùƒ ØªØ®Ù„Ù‚ Ø¨Ù†Ø¬Ø§Ø­";
  } catch (e) {
    alert(e.message);
  }
};

/* ğŸ”¹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
window.login = async () => {
  const email = emailInput.value.trim();
  const pass = passInput.value.trim();

  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch (e) {
    alert("âŒ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  }
};

/* ğŸ”¹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬Ù„Ø³Ø© */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    authBox.style.display = "none";
    appBox.style.display = "block";
    loadUser(user.uid);
  }
});

/* ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
async function loadUser(uid) {
  const snap = await getDoc(doc(db, "users", uid));
  const data = snap.data();

  document.getElementById("balance").innerText = data.balance;
  document.getElementById("ref").innerText =
    location.origin + "?ref=" + data.referralCode;
}

/* ğŸ”¹ Ø§Ù„Ù…Ù‡Ø§Ù… */
window.startTask = async (id) => {
  if (currentTaskRunning) return alert("â³ Ù‡Ù†Ø§Ùƒ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„");

  const user = auth.currentUser;
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  const data = snap.data();

  const now = Date.now();
  const last = data.lastTasks?.[id] || 0;

  if (now - last < 86400000) {
    return alert("â›” Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©");
  }

  currentTaskRunning = true;
  const btn = document.getElementById("task" + id);
  btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°";

  setTimeout(async () => {
    await updateDoc(ref, {
      balance: data.balance + 10,
      [`lastTasks.${id}`]: Date.now()
    });
    btn.innerText = "âœ… ØªÙ…Øª";
    currentTaskRunning = false;
    document.getElementById("balance").innerText = data.balance + 10;
  }, 30000);
};

/* ğŸ”¹ Ø³Ø­Ø¨ Ø±Ø§ØªØ¨ ÙˆÙ‡Ù…ÙŠ */
window.withdraw = async () => {
  const amount = parseInt(document.getElementById("withdraw").value);
  const user = auth.currentUser;
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  const data = snap.data();

  if (amount > data.balance) return alert("âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  await updateDoc(ref, {
    balance: data.balance - amount
  });

  document.getElementById("balance").innerText = data.balance - amount;
  alert("ğŸ’° ØªÙ… Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ (ÙˆÙ‡Ù…ÙŠ)");
};
</script>

<style>
body {
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#141e30,#243b55);
  color:#fff;
}
.box {
  background:#1e1e2f;
  padding:20px;
  max-width:350px;
  margin:40px auto;
  border-radius:12px;
}
input,button {
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:none;
}
button {
  background:#00c6ff;
  font-weight:bold;
}
.task {
  background:#2a2a40;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="box" id="auth">
  <h2>ğŸš€ MaliApp</h2>
  <input id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="passInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="inviteInput" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <p id="status"></p>
</div>

<div class="box" id="app" style="display:none">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <p>ğŸ”— Ø±Ø§Ø¨Ø·Ùƒ: <span id="ref"></span></p>

  <h4>ğŸ“‹ Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</h4>
  <div class="task"><button id="task1" onclick="startTask(1)">Ù…Ù‡Ù…Ø© 1 (30Ø«)</button></div>
  <div class="task"><button id="task2" onclick="startTask(2)">Ù…Ù‡Ù…Ø© 2 (30Ø«)</button></div>
  <div class="task"><button id="task3" onclick="startTask(3)">Ù…Ù‡Ù…Ø© 3 (30Ø«)</button></div>
  <div class="task"><button id="task4" onclick="startTask(4)">Ù…Ù‡Ù…Ø© 4 (30Ø«)</button></div>
  <div class="task"><button id="task5" onclick="startTask(5)">Ù…Ù‡Ù…Ø© 5 (30Ø«)</button></div>

  <h4>ğŸ¦ Ø³Ø­Ø¨ Ø±Ø§ØªØ¨</h4>
  <input id="withdraw" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="withdraw()">Ø³Ø­Ø¨</button>
</div>

</body>
</html>
