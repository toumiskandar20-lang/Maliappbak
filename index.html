<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{margin:0;font-family:Arial;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;}
.box{max-width:420px;margin:25px auto;background:#111;border-radius:16px;padding:20px;}
input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;}
button{background:#00c853;font-weight:bold;cursor:pointer;}
.task,.history-card,.level-card,.wallet-box{background:#222;padding:12px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;}
.badge{padding:4px 10px;border-radius:12px;font-size:12px;}
.pending{background:#ff9800}.approved{background:#00c853}.rejected{background:#d50000}
.copy-btn{background:#333;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;}
.hidden{display:none;}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#00c853;color:#000;padding:14px 22px;border-radius:30px;font-weight:bold;display:none;z-index:999;}
.settings-btn{position:fixed;right:20px;bottom:20px;width:55px;height:55px;border-radius:50%;background:#00c853;display:flex;align-items:center;justify-content:center;font-size:22px;color:#000;}
.level-card p{font-size:14px;opacity:.9;}
.level-card h4{margin-bottom:8px;}
.levelup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:9999;display:none;}
.levelup-overlay.show{display:flex;}
.levelup-popup{background:#111;width:90%;max-width:360px;padding:30px 20px;border-radius:18px;text-align:center;animation:popupScale .4s ease;}
.levelup-icon{width:80px;height:80px;margin:auto;background:linear-gradient(135deg,#00c853,#b2ff59);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:34px;color:#000;margin-bottom:15px;}
@keyframes popupScale{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="openRegister()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- REGISTER -->
<div class="box hidden" id="registerBox">
  <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <input id="regEmail" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="regPhone" type="tel" placeholder="ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="regPassword" type="password" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regConfirm" type="password" placeholder="ğŸ”‘ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regInvite" placeholder="ğŸ†” Ù…Ø¹Ø±Ù ØµØ§Ø­Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="submitRegister()">âœ… ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="backToLogin()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- TOAST -->
<div class="toast" id="welcomeToast">ğŸ‰ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ MaliApp!</div>

<!-- LEVEL UP POPUP -->
<div class="levelup-overlay" id="levelUpOverlay">
  <div class="levelup-popup">
    <div class="levelup-icon"><i class="fa-solid fa-trophy"></i></div>
    <h2>ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© ğŸ‰</h2>
    <p>ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰<br><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="popupLevel"></span></strong></p>
    <button onclick="closeLevelUp()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
  </div>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>ğŸš€ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>
  <button onclick="openProfile()">ğŸ‘¤ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ</button>
  <button onclick="openSettings()">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  <button onclick="openWithdraw()">ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
  <button onclick="openTopup()">ğŸ’³ ØªØ¹Ø¨Ø¦Ø© Ø±ØµÙŠØ¯</button>
  <button onclick="openUpgrade()">ğŸš€ ØªØ±Ù‚ÙŠØ© Ù…Ø³ØªÙˆÙ‰</button>

  <h3>ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
  <div id="tasksBox"></div>

  <h3>âš½ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
  <div id="matchesBox"></div>
</div>

<!-- AUDIO -->
<audio id="levelUpSound" preload="auto">
  <source src="level-up.mp3" type="audio/mpeg">
</audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",authDomain:"maliapp-63f91.firebaseapp.com",projectId:"maliapp-63f91"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let userData={};
let currentTask=false;
let userBets={};

const LEVELS={1:{tasks:5,reward:10},2:{tasks:11,reward:15,price:230},3:{tasks:23,reward:20,price:590}};
const matches=[
  {id:1,teamA:"ØªÙˆÙ†Ø³",teamB:"Ø§Ù„Ù…ØºØ±Ø¨",startTime:"2025-12-25T18:00:00Z",endTime:"2025-12-25T20:00:00Z",result:null},
  {id:2,teamA:"Ø§Ù„Ù…ØºØ±Ø¨",teamB:"Ù…ØµØ±",startTime:"2025-12-25T21:00:00Z",endTime:"2025-12-25T23:00:00Z",result:null}
];

const levelUpSound=document.getElementById("levelUpSound");

/* AUTH */
window.login=async()=>signInWithEmailAndPassword(auth,email.value,password.value);
window.register=async()=>createUserWithEmailAndPassword(auth,email.value,password.value);

onAuthStateChanged(auth,async u=>{
  if(!u) return;
  userData=(await getDoc(doc(db,"users",u.uid))).data();
  authBox.classList.add("hidden"); appBox.classList.remove("hidden");
  updateUI(); loadTasks(); loadMatches();
});

/* UI */
function updateUI(){balance.innerText=userData.balance; level.innerText=userData.level;}

/* TASKS */
function loadTasks(){
  tasksBox.innerHTML="";
  for(let i=1;i<=LEVELS[userData.level].tasks;i++)
    tasksBox.innerHTML+=`<div class="task">Ù…Ù‡Ù…Ø© ${i}<button onclick="startTask(this)">Ø§Ø¨Ø¯Ø£</button></div>`;
}
window.startTask=async(btn)=>{
  if(currentTask) return alert("âŒ ØªÙˆØ¬Ø¯ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°");
  currentTask=true; let t=20; btn.disabled=true;
  const timer=setInterval(async()=>{
    btn.innerText=t--;
    if(t<0){
      clearInterval(timer); btn.innerText="âœ” ØªÙ…Øª"; currentTask=false;
      userData.balance+=LEVELS[userData.level].reward;
      await updateDoc(doc(db,"users",auth.currentUser.uid),userData); updateUI();
    }
  },1000);
};

/* MATCHES */
function loadMatches(){
  matchesBox.innerHTML="";
  const now=new Date();
  matches.forEach(match=>{
    const start=new Date(match.startTime);
    const canBet=now<start;
    matchesBox.innerHTML+=`
      <div class="task">${match.teamA} ğŸ†š ${match.teamB}<br><small>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${start.toLocaleString()}</small>
      <div>
        <button onclick="placeBet(${match.id},'1')" ${!canBet?'disabled':''}>1</button>
        <button onclick="placeBet(${match.id},'X')" ${!canBet?'disabled':''}>X</button>
        <button onclick="placeBet(${match.id},'2')" ${!canBet?'disabled':''}>2</button>
      </div></div>`;
  });
}
window.placeBet=(matchId,choice)=>{userBets[matchId]={bet:choice,claimed:false}; alert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø±Ù‡Ø§Ù†Ùƒ: ${choice}`);}
function generateMatchResult(match){if(match.result) return; match.result=["1","X","2"][Math.floor(Math.random()*3)];}
async function checkMatchResults(){
  const now=new Date();
  for(const match of matches){
    const end=new Date(match.endTime);
    if(now>=end && !match.result) generateMatchResult(match);
    if(match.result && userBets[match.id] && !userBets[match.id].claimed){
      let reward=0; if(userData.level===1) reward=0.5; else if(userData.level===2) reward=1.5; else if(userData.level===3) reward=3;
      if(userBets[match.id].bet===match.result){
        userData.balance+=reward; await updateDoc(doc(db,"users",auth.currentUser.uid),userData); updateUI();
        alert(`ğŸ† Ø±Ø¨Ø­Ùƒ ${reward} Ù…Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${match.teamA} vs ${match.teamB}`);
      }
      userBets[match.id].claimed=true;
    }
  }
}
setInterval(checkMatchResults,60*1000);

/* LEVEL UP */
window.upgradeLevel=async(lvl)=>{
  const p=LEVELS[lvl].price;
  if(userData.balance<p) return alert("âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");
  userData.balance-=p; userData.level=lvl;
  await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
  updateUI(); loadTasks(); showLevelUp(lvl);
}
window.showLevelUp=(lvl)=>{levelUpSound.play(); popupLevel.innerText=lvl; levelUpOverlay.classList.add("show");}
window.closeLevelUp=()=>{levelUpOverlay.classList.remove("show");}

/* PROFILE, SETTINGS, COPY, WITHDRAW... */
/* ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù…Ù† Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© updateUI Ùˆ loadTasks Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */
</script>
</body>
</html>
