<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.box{
  max-width:420px;
  margin:25px auto;
  background:#111;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
button{background:#00c853;font-weight:bold}
.row{display:flex;gap:8px}
.row input{flex:1}
.badge{background:#ff9800;padding:4px 10px;border-radius:12px;font-size:12px}
.history-card{
  background:#1c1c1c;
  padding:12px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  justify-content:space-between;
}
.toast{
  position:fixed;
  bottom:90px;
  left:50%;
  transform:translateX(-50%);
  background:#00c853;
  color:#000;
  padding:10px 18px;
  border-radius:20px;
  display:none;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="box" id="appBox" style="display:none">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <button onclick="openWithdraw()">ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
</div>

<!-- WITHDRAW PAGE -->
<div class="box" id="withdrawBox" style="display:none">
  <h3>ğŸ’¸ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>

  <label>Ù…Ø­ÙØ¸ØªÙƒ</label>
  <div class="row">
    <input id="walletInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ">
    <button onclick="saveWallet()">ğŸ“‹</button>
  </div>

  <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨</label>
  <div class="row">
    <input id="withdrawAmount" type="number" placeholder="0">
    <button onclick="maxAmount()">MAX</button>
  </div>

  <button onclick="submitWithdraw()">Ù‚Ù… Ø¨Ø£Ù…Ø± Ø§Ù„Ø³Ø­Ø¨</button>

  <h4>ğŸ“œ Historique</h4>
  <div id="history"></div>

  <p style="font-size:13px;color:#ccc">
    Ø¹Ø²ÙŠØ² Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨ÙŠÙ† 24 Ø¥Ù„Ù‰ 72 Ø³Ø§Ø¹Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
  </p>

  <button onclick="back()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<div class="toast" id="toast">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore,doc,setDoc,getDoc,updateDoc,addDoc,collection,query,where,getDocs,serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain:"maliapp-63f91.firebaseapp.com",
  projectId:"maliapp-63f91"
});

const auth=getAuth(app);
const db=getFirestore(app);
let userData={};

window.register=async()=>{
  const c=await createUserWithEmailAndPassword(auth,email.value,password.value);
  await setDoc(doc(db,"users",c.user.uid),{balance:0});
};

window.login=async()=>{await signInWithEmailAndPassword(auth,email.value,password.value)};

onAuthStateChanged(auth,async u=>{
  if(!u)return;
  const s=await getDoc(doc(db,"users",u.uid));
  userData=s.data();
  authBox.style.display="none";
  appBox.style.display="block";
  balance.innerText=userData.balance;
  if(userData.wallet) walletInput.value=userData.wallet;
  loadHistory();
});

window.openWithdraw=()=>{
  appBox.style.display="none";
  withdrawBox.style.display="block";
};

window.back=()=>{
  withdrawBox.style.display="none";
  appBox.style.display="block";
};

window.saveWallet=async()=>{
  if(userData.wallet)return;
  const w=walletInput.value;
  if(!w)return;
  userData.wallet=w;
  await updateDoc(doc(db,"users",auth.currentUser.uid),{wallet:w});
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2000);
};

window.maxAmount=()=>withdrawAmount.value=userData.balance;

window.submitWithdraw=async()=>{
  const amount=Number(withdrawAmount.value);
  if(amount<=0||amount>userData.balance)return;
  userData.balance-=amount;
  await addDoc(collection(db,"withdrawals"),{
    userId:auth.currentUser.uid,
    amount,
    wallet:userData.wallet,
    status:"ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
    createdAt:serverTimestamp()
  });
  await updateDoc(doc(db,"users",auth.currentUser.uid),{balance:userData.balance});
  balance.innerText=userData.balance;
  withdrawAmount.value="";
  loadHistory();
};

async function loadHistory(){
  history.innerHTML="";
  const q=query(collection(db,"withdrawals"),where("userId","==",auth.currentUser.uid));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    const w=d.data();
    history.innerHTML+=`
    <div class="history-card">
      <span>${w.amount}</span>
      <span class="badge">${w.status}</span>
    </div>`;
  });
}
</script>

</body>
</html>
