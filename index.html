<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* ===== AUTH ===== */
window.register = function () {
  const email = emailR.value;
  const pass = passR.value;
  const pass2 = passR2.value;

  if(pass !== pass2){ alert("كلمة المرور غير متطابقة"); return; }

  createUserWithEmailAndPassword(auth,email,pass)
  .then(()=>{
    initUser();
    showApp();
  }).catch(e=>alert(e.message));
};

window.login = function () {
  signInWithEmailAndPassword(auth,emailL.value,passL.value)
  .then(showApp)
  .catch(e=>alert(e.message));
};

window.logout = function(){
  signOut(auth).then(()=>location.reload());
};

/* ===== USER INIT ===== */
function initUser(){
  if(!localStorage.balance){
    localStorage.balance = 0;
    localStorage.team = JSON.stringify([]);
    localStorage.ref = Math.floor(100000 + Math.random()*900000);
    localStorage.tasks = JSON.stringify({});
  }
}

/* ===== APP ===== */
function showApp(){
  authBox.style.display="none";
  appBox.style.display="block";
  referral.innerText = location.origin + "?ref=" + localStorage.ref;
  balance.innerText = localStorage.balance;
  renderTasks();
  renderTeam();
}

/* ===== TASKS ===== */
let running = false;
const tasks = [
  {id:1,title:"مهمة 1"},
  {id:2,title:"مهمة 2"},
  {id:3,title:"مهمة 3"},
  {id:4,title:"مهمة 4"},
  {id:5,title:"مهمة 5"},
];

function renderTasks(){
  tasksBox.innerHTML="";
  let saved = JSON.parse(localStorage.tasks||"{}");

  tasks.forEach(t=>{
    const doneTime = saved[t.id];
    const now = Date.now();
    let btnText="ابدأ";
    let disabled=false;

    if(doneTime && now-doneTime < 86400000){
      btnText="تمت المهمة";
      disabled=true;
    }

    const div=document.createElement("div");
    div.className="task";
    div.innerHTML=`<span>${t.title}</span>`;
    const btn=document.createElement("button");
    btn.innerText=btnText;
    btn.disabled=disabled;
    btn.onclick=()=>startTask(t.id,btn);
    div.appendChild(btn);
    tasksBox.appendChild(div);
  });
}

function startTask(id,btn){
  if(running){ alert("هناك مهمة قيد التشغيل"); return; }
  running=true;
  btn.innerText="30...";
  let time=30;
  const int=setInterval(()=>{
    time--;
    btn.innerText=time+"...";
    if(time<=0){
      clearInterval(int);
      completeTask(id,btn);
    }
  },1000);
}

function completeTask(id,btn){
  running=false;
  btn.innerText="تمت المهمة";
  btn.disabled=true;
  localStorage.balance = Number(localStorage.balance)+10;
  balance.innerText=localStorage.balance;
  let saved=JSON.parse(localStorage.tasks||"{}");
  saved[id]=Date.now();
  localStorage.tasks=JSON.stringify(saved);
}

/* ===== TEAM ===== */
function addFriend(){
  const name=friend.value;
  if(!name)return;
  let team=JSON.parse(localStorage.team);
  const level=Math.floor(team.length/3)+1;
  team.push({name,level});
  localStorage.team=JSON.stringify(team);
  localStorage.balance=Number(localStorage.balance)+10;
  balance.innerText=localStorage.balance;
  friend.value="";
  renderTeam();
}

function renderTeam(){
  teamBox.innerHTML="";
  JSON.parse(localStorage.team).forEach(m=>{
    teamBox.innerHTML+=`<div class="member">${m.name} | مستوى ${m.level}</div>`;
  });
}

/* ===== SALARY ===== */
function withdraw(){
  const a=Number(amount.value);
  if(a<=0 || a>localStorage.balance){ alert("رصيد غير كافي"); return; }
  localStorage.balance-=a;
  balance.innerText=localStorage.balance;
  alert("تم سحب الراتب");
  amount.value="";
}
</script>

<style>
body{margin:0;font-family:Arial;background:#0f2027;color:#fff}
.box{background:#1c1c1c;padding:20px;border-radius:12px;width:350px;margin:auto;margin-top:30px}
input,button{width:100%;padding:10px;margin:5px 0;border-radius:6px;border:none}
button{background:#00c853;color:#000;font-weight:bold}
.task,.member{background:#2c2c2c;padding:8px;margin:5px 0;border-radius:6px}
nav{display:flex;justify-content:space-between}
</style>
</head>

<body>

<div class="box" id="authBox">
<h2>MaliApp</h2>
<input id="emailR" placeholder="Email">
<input id="passR" type="password" placeholder="Password">
<input id="passR2" type="password" placeholder="Confirm Password">
<button onclick="register()">تسجيل</button>
<hr>
<input id="emailL" placeholder="Email">
<input id="passL" type="password" placeholder="Password">
<button onclick="login()">دخول</button>
</div>

<div class="box" id="appBox" style="display:none">
<nav>
<span>الرصيد: <b id="balance">0</b></span>
<button onclick="logout()">خروج</button>
</nav>

<p>رابط الدعوة: <small id="referral"></small></p>

<h3>المهام (المستوى 1)</h3>
<div id="tasksBox"></div>

<h3>الفريق</h3>
<input id="friend" placeholder="اسم العضو">
<button onclick="addFriend()">إضافة</button>
<div id="teamBox"></div>

<h3>سحب راتب</h3>
<input id="amount" type="number">
<button onclick="withdraw()">سحب</button>
</div>

</body>
</html>
