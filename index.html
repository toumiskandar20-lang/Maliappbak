<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body{margin:0;font-family:Arial;background:#111;color:#fff;}
.box{max-width:420px;margin:25px auto;background:#222;border-radius:16px;padding:20px;}
input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;}
button{background:#00c853;font-weight:bold;cursor:pointer;}
.task{background:#333;padding:12px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;}
.hidden{display:none;}
  .match-card{
  background: linear-gradient(145deg,#1e1e1e,#2a2a2a);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.4);
}

.match-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.team{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:bold;
}

.team i{
  font-size:20px;
  color:#00e676;
}

.vs{
  font-size:13px;
  opacity:.7;
}

.match-time{
  font-size:12px;
  background:#111;
  padding:4px 8px;
  border-radius:6px;
  opacity:.8;
}

.bet-buttons{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:10px;
}

.bet-btn{
  background:#111;
  border:1px solid #333;
  border-radius:10px;
  padding:10px;
  font-size:16px;
  font-weight:bold;
  color:#fff;
  transition:.2s;
}

.bet-btn:hover{
  background:#00c853;
  color:#000;
}

.bet-btn:disabled{
  opacity:.4;
  cursor:not-allowed;
}
  .bet-btn.selected{
  background:#00e676;
  color:#000;
}
  .bet-status{
  margin-top:6px;
  font-weight:bold;
  font-size:14px;
}

.bet-win{
  color:#00e676;
}

.bet-lose{
  color:#ff5252;
}

.bet-pending{
  color:#ffc107;
}

.badge{
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
  .section-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:18px 0 12px;
  padding-bottom:10px;
  border-bottom:1px solid #2f2f2f;
}

.title-left{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:700;
}

.title-left i{
  color:#00e676;
  font-size:20px;
}

.live-dot{
  font-size:11px;
  font-weight:bold;
  color:#000;
  background:#ff1744;
  padding:4px 8px;
  border-radius:20px;
  animation:pulse 1.5s infinite;
}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,23,68,.6);}
  70%{box-shadow:0 0 0 10px rgba(255,23,68,0);}
  100%{box-shadow:0 0 0 0 rgba(255,23,68,0);}
}
 .pro-time{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  background:#111;
  padding:6px 10px;
  border-radius:10px;
  width:fit-content;
  margin-top:8px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
}

.pro-time i{
  color:#00e676;
  font-size:15px;
}

.time-text{
  opacity:.85;
}

.time-sep{
  opacity:.4;
}

.time-hour{
  font-weight:bold;
  letter-spacing:.5px;
} 
  .back-btn{
  background: linear-gradient(145deg,#1e1e1e,#2b2b2b);
  color:#fff;
  border:1px solid #333;
  border-radius:12px;
  padding:12px 16px;
  font-size:15px;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  cursor:pointer;
  transition:.25s;
}

.back-btn i{
  font-size:16px;
  color:#00e676;
}

.back-btn:hover{
  background:#00e676;
  color:#000;
}

.back-btn:hover i{
  color:#000;
}
</style>
</head>
<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="openRegister()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- REGISTER -->
<div class="box hidden" id="registerBox">
  <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <input id="regEmail" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="regPhone" type="tel" placeholder="ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="regPassword" type="password" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regConfirm" type="password" placeholder="ğŸ”‘ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="submitRegister()">âœ… ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="backToLogin()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>ğŸ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>
<button onclick="openMyBets()" style="margin-top:10px">
  <i class="fa-solid fa-ticket"></i> Ø±Ù‡Ø§Ù†Ø§ØªÙŠ
</button>
<div class="section-title">
  <div class="title-left">
    <i class="fa-solid fa-futbol"></i>
    <span>Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
  </div>

  <span class="live-dot">LIVE</span>
</div>
  <div id="matchesBox"></div>
</div>
<!-- MY BETS -->
<div class="box hidden" id="myBetsBox">
 <h3>
  <i class="fa-solid fa-ticket"></i> Ø±Ù‡Ø§Ù†Ø§ØªÙŠ
</h3>

  <div id="myBetsList">
    <!-- Ø§Ù„ØªÙƒÙ‡Ù†Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
  </div>

<button onclick="backToMatches()" class="back-btn">
  <i class="fa-solid fa-arrow-left"></i>
  Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
</button>
</div>
<script type="module">
/* ================= IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  query,
  where,
  serverTimestamp,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const LEVEL_REWARDS = {
  1: 0.5,
  2: 1.5,
  3: 3
};
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
async function getMatchesMap(){
  const map = {};
  const snap = await getDocs(collection(db,"matches"));

  snap.forEach(docu=>{
    map[docu.id] = docu.data();
  });

  return map;
}
/* ================= GLOBAL ================= */
let userData = {};
let matches = [];

/* ================= LEVELS ================= */
const LEVELS = {
  1: { reward: 0.5 },
  2: { reward: 1.5 },
  3: { reward: 3 }
};

/* ================= UI ================= */
function updateUI(){
  balance.innerText = userData.balance ?? 0;
  level.innerText = userData.level ?? 1;
}

/* ================= AUTH ================= */
window.openRegister = ()=>{
  authBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
};

window.backToLogin = ()=>{
  registerBox.classList.add("hidden");
  authBox.classList.remove("hidden");
};

window.submitRegister = async ()=>{
  const email = regEmail.value.trim();
  const phone = regPhone.value.trim();
  const pass = regPassword.value;
  const confirm = regConfirm.value;

  if(!email || !phone || !pass || pass !== confirm){
    alert("âŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth,email,pass);

  await setDoc(doc(db,"users",cred.user.uid),{
    email,
    phone,
    balance: 1000,
    level: 1,
    createdAt: serverTimestamp()
  });

  registerBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

/* ================= AUTH STATE ================= */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  userData = snap.data();

  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");

  updateUI();
  await fetchMatches();
});
window.openMyBets = ()=>{
  appBox.classList.add("hidden");
  myBetsBox.classList.remove("hidden");

  // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ù‡Ù†Ø§
  const myBetsList = document.getElementById("myBetsList");
  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

  loadMyBets();
};

 async function loadMyBets(){
  const myBetsList = document.getElementById("myBetsList");
  const user = auth.currentUser;

  if(!user){
    myBetsList.innerHTML = "âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
    return;
  }

  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

  const matchesMap = await getMatchesMap();

  const q = query(
    collection(db,"bets"),
    where("userId","==",user.uid)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    myBetsList.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒÙ‡Ù†Ø§Øª";
    return;
  }

  myBetsList.innerHTML = "";

  snap.forEach(docu=>{
    const b = docu.data();
    const match = matchesMap[b.matchId];

    let statusClass = "bet-pending";
    let statusText  = '<i class="fa-solid fa-hourglass-half"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';

    if(match?.result){
      if(b.choice === match.result){
        statusClass = "bet-win";
       statusText = `<i class="fa-solid fa-trophy"></i> ÙÙˆØ²`;
      }else{
        statusClass = "bet-lose";
        statusText = `<i class="fa-solid fa-circle-xmark"></i> Ø®Ø³Ø§Ø±Ø©`;
      }
    }

    myBetsList.innerHTML += `
      <div class="match-card">
        <div style="display:flex;justify-content:space-between">
          <strong>
  ${match?.teamA ?? "ØŸ"}
  <i class="fa-solid fa-bolt" style="margin:0 6px;color:#00e676"></i>
  ${match?.teamB ?? "ØŸ"}
</strong>
          <span class="badge ${statusClass}">
            ${statusText}
          </span>
        </div>

       <div style="margin-top:8px">
  <i class="fa-solid fa-crosshairs" style="margin-left:6px"></i>
  Ø§Ø®ØªÙŠØ§Ø±Ùƒ:
  <strong style="font-size:18px">${b.choice}</strong>
</div>

        <div class="bet-status ${statusClass}">
  <i class="fa-solid fa-flag-checkered" style="margin-left:6px"></i>
  Ø§Ù„Ù†ØªÙŠØ¬Ø©:
  ${match?.result ?? "Ù„Ù… ØªÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯"}
</div>
<div class="bet-status ${statusClass}">
  <i class="fa-solid fa-coins"></i>
  Ø§Ù„Ø±Ø¨Ø­:
  <strong>
    ${b.choice === match?.result 
      ? `+${LEVEL_REWARDS[userData.level]} ğŸ’°`
      : "0"}
  </strong>
</div>
      </div>
    `;
  });
}
/* ================= MATCHES ================= */
async function fetchMatches(){
  matchesBox.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª...";
  matches = [];

  const q = query(collection(db,"matches"));
  const snap = await getDocs(q);

  snap.forEach(docu=>{
    const d = docu.data();
    matches.push({
      id: docu.id,
      teamA: d.teamA,
      teamB: d.teamB,
      startTime: d.startTime.toDate(),
      endTime: d.endTime.toDate(),
      result: d.result ?? null,
      settled: d.settled ?? false
    });
  });

  loadMatches(); 
}
function loadMatches(){
  matchesBox.innerHTML = "";

  if(matches.length === 0){
    matchesBox.innerHTML = "<p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª</p>";
    return;
  }

  const now = new Date();

  matches.forEach(m=>{
    const canBet = now < m.startTime;
const isToday =
  new Date().toDateString() === m.startTime.toDateString();
    matchesBox.innerHTML += `
      <div class="match-card">
        <div class="match-header">
          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamA}
          </div>

          <span class="vs">VS</span>

          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamB}
          </div>
        </div>

       <div class="match-time pro-time">
  <i class="fa-solid fa-clock"></i>
  <span class="time-text">
   ${isToday ? "Ø§Ù„ÙŠÙˆÙ…" : m.startTime.toLocaleDateString("ar-TN")}
  </span>
  <span class="time-sep">â€¢</span>
  <span class="time-hour">
    ${m.startTime.toLocaleTimeString("ar-TN", { hour: "2-digit", minute: "2-digit" })}
  </span>
</div>
        <div class="bet-buttons">
   <button class="bet-btn"
        data-id="${m.id}"
        data-choice="1"
        onclick="placeBet('${m.id}','1', this)">
  1
</button>

<button class="bet-btn"
        data-id="${m.id}"
        data-choice="X"
        onclick="placeBet('${m.id}','X', this)">
  X
</button>

<button class="bet-btn"
        data-id="${m.id}"
        data-choice="2"
        onclick="placeBet('${m.id}','2', this)">
  2
</button>
        </div>
      </div>
    `;
  });
 
}

/* ================= BET ================= */
window.placeBet = async (matchId, choice, btn)=>{
  try{
    const user = auth.currentUser;

    // ğŸ” Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø·
    console.log("USER:", user?.uid);

    if(!user){
      alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      return;
    }

    const betRef = doc(db,"bets",`${user.uid}_${matchId}`);
    const snap = await getDoc(betRef);

    if(snap.exists()){
      alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙƒÙ‡Ù†");
      return;
    }

    await setDoc(betRef,{
      userId: user.uid,
      matchId,
      choice,
      settled: false,
      createdAt: serverTimestamp()
    });

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø²Ø±
    btn.classList.add("selected");

    // ØªØ¹Ø·ÙŠÙ„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    btn.parentElement.querySelectorAll(".bet-btn").forEach(b=>{
      b.disabled = true;
    });

    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙƒÙ‡Ù†: " + choice);

  }catch(e){
    console.error("FIRESTORE ERROR ğŸ‘‰", e);
    alert(e.message);
  }
};

/* ================= SETTLE MATCH ================= */
async function settleMatch(match){
  const betsQ = query(
    collection(db,"bets"),
    where("matchId","==",match.id),
    where("settled","==",false)
  );

  const betsSnap = await getDocs(betsQ);

  for(const betDoc of betsSnap.docs){
    const bet = betDoc.data();

    // âœ… Ø¥Ø°Ø§ Ø§Ù„ØªÙƒÙ‡Ù† ØµØ­ÙŠØ­
    if(bet.choice === match.result){
      const userRef = doc(db,"users",bet.userId);
      const userSnap = await getDoc(userRef);

      if(userSnap.exists()){
        const lvl = userSnap.data().level || 1;
        const reward = LEVEL_REWARDS[lvl] || 0.5;

        await updateDoc(userRef,{
          balance: (userSnap.data().balance || 0) + reward
        });
      }
    }

    // ğŸ”’ Ù‚ÙÙ„ Ø§Ù„ØªÙƒÙ‡Ù†
    await updateDoc(betDoc.ref,{
      settled: true
    });
  }

  // ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
  await updateDoc(doc(db,"matches",match.id),{
    settled: true
  });

  console.log("âœ… ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:", match.id);
}
/* ================= LOGOUT ================= */
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};
  window.backToMatches = ()=>{
  myBetsBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};
</script>

</body>
</html>
