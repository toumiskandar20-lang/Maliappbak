<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.box{
  max-width:420px;
  margin:25px auto;
  background:#111;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
button{
  background:#00c853;
  font-weight:bold;
  cursor:pointer;
}
.task,.history-card,.level-card,.wallet-box{
  background:#222;
  padding:12px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
}
.pending{background:#ff9800}
.approved{background:#00c853}
.rejected{background:#d50000}
.copy-btn{
  background:#333;
  color:#fff;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
}
.hidden{display:none}
.toast{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:#00c853;
  color:#000;
  padding:10px 18px;
  border-radius:20px;
  display:none;
}
.settings-btn{
  position:fixed;
  right:20px;
  bottom:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#00c853;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  color:#000;
}
</style>
</head>

<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

  <button onclick="openWithdraw()">ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
  <button onclick="openTopup()">ğŸ’³ ØªØ¹Ø¨Ø¦Ø© Ø±ØµÙŠØ¯</button>
  <button onclick="openUpgrade()">ğŸš€ ØªØ±Ù‚ÙŠØ© Ù…Ø³ØªÙˆÙ‰</button>

  <h3>ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
  <div id="tasksBox"></div>
</div>

<!-- WITHDRAW PAGE -->
<div class="box hidden" id="withdrawBox">
  <h3>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</h3>

  <input id="walletInput" placeholder="Wallet address">
  <button class="copy-btn" onclick="copyWallet()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>

  <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="setMax()">MAX</button>
  <button onclick="submitWithdraw()">âœ… ØªÙ†ÙÙŠØ°</button>

  <h4>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</h4>
  <div id="withdrawHistory"></div>

  <button onclick="back()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- TOPUP -->
<div class="box hidden" id="topupBox">
  <h3>ğŸ’³ ØªØ¹Ø¨Ø¦Ø© Ø±ØµÙŠØ¯</h3>
  <div class="wallet-box">
    <span id="walletText">TE3THEisH6nttHBWtJiKpreaxvPGt5sZVW</span>
    <span class="copy-btn" onclick="copyTopup()">ğŸ“‹</span>
  </div>
  <button onclick="back()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- UPGRADE -->
<div class="box hidden" id="upgradeBox">
  <h3>ğŸš€ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h3>

  <div class="level-card">
    <div>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2 â€” 230 Ù…Ø§Ù„ÙŠ</div>
    <button onclick="upgradeLevel(2)">ØªØ±Ù‚ÙŠØ©</button>
  </div>

  <div class="level-card">
    <div>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3 â€” 590 Ù…Ø§Ù„ÙŠ</div>
    <button onclick="upgradeLevel(3)">ØªØ±Ù‚ÙŠØ©</button>
  </div>

  <button onclick="back()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<div class="toast" id="toast">âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®</div>

<div class="settings-btn" onclick="logout()">
  <i class="fa fa-sign-out"></i>
</div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,createUserWithEmailAndPassword,
  signInWithEmailAndPassword,onAuthStateChanged,signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,doc,setDoc,getDoc,updateDoc,
  addDoc,collection,query,where,getDocs,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain:"maliapp-63f91.firebaseapp.com",
  projectId:"maliapp-63f91"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let userData={};
let currentTask=false;

const LEVELS={
  1:{tasks:5,reward:10},
  2:{tasks:11,reward:15,price:230},
  3:{tasks:23,reward:20,price:590}
};

/* AUTH */
window.register=async()=>{
  const c=await createUserWithEmailAndPassword(auth,email.value,password.value);
  await setDoc(doc(db,"users",c.user.uid),{
    balance:0,
    level:1
  });
};

window.login=async()=>signInWithEmailAndPassword(auth,email.value,password.value);

onAuthStateChanged(auth,async u=>{
  if(!u)return;
  userData=(await getDoc(doc(db,"users",u.uid))).data();
  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");
  updateUI();
  loadTasks();
});

/* UI */
function updateUI(){
  balance.innerText=userData.balance;
  level.innerText=userData.level;
}

/* TASKS */
function loadTasks(){
  tasksBox.innerHTML="";
  for(let i=1;i<=LEVELS[userData.level].tasks;i++){
    tasksBox.innerHTML+=`
      <div class="task">
        Ù…Ù‡Ù…Ø© ${i}
        <button onclick="startTask(this)">Ø§Ø¨Ø¯Ø£</button>
      </div>`;
  }
}

window.startTask=async(btn)=>{
  if(currentTask)return alert("âŒ ØªÙˆØ¬Ø¯ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°");
  currentTask=true;
  let t=20;
  btn.disabled=true;

  const timer=setInterval(async()=>{
    btn.innerText=t--;
    if(t<0){
      clearInterval(timer);
      btn.innerText="âœ” ØªÙ…Øª";
      currentTask=false;
      userData.balance+=LEVELS[userData.level].reward;
      await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
      updateUI();
    }
  },1000);
};

/* WITHDRAW */
window.openWithdraw=()=>{
  appBox.classList.add("hidden");
  withdrawBox.classList.remove("hidden");
  loadWithdrawHistory();
};

window.setMax=()=>withdrawAmount.value=userData.balance;

window.submitWithdraw=async()=>{
  const a=Number(withdrawAmount.value);
  if(a<=0||a>userData.balance)return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­");
  userData.balance-=a;
  await addDoc(collection(db,"withdrawals"),{
    userId:auth.currentUser.uid,
    amount:a,
    status:"pending",
    createdAt:serverTimestamp()
  });
  await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
  updateUI();
  loadWithdrawHistory();
};

import { collection, onSnapshot, addDoc, serverTimestamp, updateDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// --- LOAD WITHDRAW HISTORY ---
function loadWithdrawHistory(){
  const colRef = collection(db, "withdrawals");

  onSnapshot(colRef, (snap) => {
    withdrawHistory.innerHTML = "";

    snap.forEach(d => {
      const w = d.data();

      // Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      if(w.userId !== auth.currentUser.uid) return;

      let cls = "pending";
      let txt = "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";

      if(w.status === "approved"){
        cls = "approved";
        txt = "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©";
      }

      if(w.status === "rejected"){
        cls = "rejected";
        txt = "Ù…Ø±ÙÙˆØ¶";
      }

      // ØªØ­ÙˆÙŠÙ„ timestamp Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª
      let dateStr = "";
      if(w.createdAt){
        const date = w.createdAt.toDate();
        dateStr = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes()}`;
      }

      withdrawHistory.innerHTML += `
        <div class="history-card">
          <div>
            ğŸ’µ ${w.amount} <br>
            ğŸ•’ ${dateStr}
          </div>
          <span class="badge ${cls}">${txt}</span>
        </div>
      `;
    });
  });
}

// --- COPY WALLET ---
window.copyWallet = () => {
  if(!walletInput.value) return alert("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­ÙØ¸Ø©");
  navigator.clipboard.writeText(walletInput.value);
  alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­");
}

// --- MAX ---
window.setMax = () => {
  withdrawAmount.value = userData.balance;
}

// --- SUBMIT WITHDRAW ---
window.submitWithdraw = async () => {
  const amount = Number(withdrawAmount.value);
  if(amount <= 0) return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­");
  if(amount > userData.balance) return alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

  userData.balance -= amount;

  await addDoc(collection(db,"withdrawals"), {
    userId: auth.currentUser.uid,
    email: auth.currentUser.email,
    wallet: walletInput.value,
    amount,
    status: "pending",
    createdAt: serverTimestamp()
  });

  await updateDoc(doc(db,"users",auth.currentUser.uid),{
    balance: userData.balance
  });

  withdrawAmount.value = "";
  updateUI();
}

// --- BACK ---
window.back = () => {
  withdrawBox.classList.add("hidden");
  appBox.classList.remove("hidden");
}
}
/* NAV */
window.openTopup=()=>{appBox.classList.add("hidden");topupBox.classList.remove("hidden");};
window.openUpgrade=()=>{appBox.classList.add("hidden");upgradeBox.classList.remove("hidden");};
window.back=()=>{
  withdrawBox.classList.add("hidden");
  topupBox.classList.add("hidden");
  upgradeBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};

/* COPY */
window.copyWallet=()=>navigator.clipboard.writeText(walletInput.value||"");
window.copyTopup=()=>{
  navigator.clipboard.writeText(walletText.innerText);
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",2000);
};

/* UPGRADE */
window.upgradeLevel=async(lvl)=>{
  const p=LEVELS[lvl].price;
  if(userData.balance<p)return alert("âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");
  userData.balance-=p;
  userData.level=lvl;
  await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
  updateUI();
  loadTasks();
  back();
};

/* LOGOUT */
window.logout=async()=>{
  await signOut(auth);
  location.reload();
};
</script>

</body>
</html>
