â€<!DOCTYPE html>
â€<html lang="ar">
â€<head>
â€<meta charset="UTF-8">
â€<title>MaliApp Test</title>
â€<meta name="viewport" content="width=device-width, initial-scale=1.0">
â€<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
â€<style>
â€body{margin:0;font-family:Arial;background:#111;color:#fff;}
â€.box{max-width:420px;margin:25px auto;background:#222;border-radius:16px;padding:20px;}
â€input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;}
â€button{background:#00c853;font-weight:bold;cursor:pointer;}
â€.task{background:#333;padding:12px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;}
â€.hidden{display:none;}
â€  .match-card{
â€  background: linear-gradient(145deg,#1e1e1e,#2a2a2a);
â€  border-radius:14px;
â€  padding:14px;
â€  margin-bottom:14px;
â€  box-shadow:0 6px 16px rgba(0,0,0,.4);
}

â€.match-header{
â€  display:flex;
â€  justify-content:space-between;
â€  align-items:center;
â€  margin-bottom:10px;
}

â€.team{
â€  display:flex;
â€  align-items:center;
â€  gap:8px;
â€  font-weight:bold;
}

â€.team i{
â€  font-size:20px;
â€  color:#00e676;
}

â€.vs{
â€  font-size:13px;
â€  opacity:.7;
}

â€.match-time{
â€  font-size:12px;
â€  background:#111;
â€  padding:4px 8px;
â€  border-radius:6px;
â€  opacity:.8;
}

â€.bet-buttons{
â€  display:grid;
â€  grid-template-columns:repeat(3,1fr);
â€  gap:10px;
â€  margin-top:10px;
}

â€.bet-btn{
â€  background:#111;
â€  border:1px solid #333;
â€  border-radius:10px;
â€  padding:10px;
â€  font-size:16px;
â€  font-weight:bold;
â€  color:#fff;
â€  transition:.2s;
}

â€.bet-btn:hover{
â€  background:#00c853;
â€  color:#000;
}

â€.bet-btn:disabled{
â€  opacity:.4;
â€  cursor:not-allowed;
}
â€  .bet-btn.selected{
â€  background:#00e676;
â€  color:#000;
}
â€  .bet-status{
â€  margin-top:6px;
â€  font-weight:bold;
â€  font-size:14px;
}

â€.bet-win{
â€  color:#00e676;
}

â€.bet-lose{
â€  color:#ff5252;
}

â€.bet-pending{
â€  color:#ffc107;
}

â€.badge{
â€  padding:4px 8px;
â€  border-radius:6px;
â€  font-size:12px;
}
â€</style>
â€</head>
â€<body>

â€<!-- AUTH -->
â€<div class="box" id="authBox">
â€  <h2>ğŸ” MaliApp</h2>
â€  <input id="email" placeholder="Email">
â€  <input id="password" type="password" placeholder="Password">
â€  <button onclick="openRegister()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
â€  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
â€</div>

â€<!-- REGISTER -->
â€<div class="box hidden" id="registerBox">
â€  <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
â€  <input id="regEmail" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
â€  <input id="regPhone" type="tel" placeholder="ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
â€  <input id="regPassword" type="password" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
â€  <input id="regConfirm" type="password" placeholder="ğŸ”‘ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
â€  <button onclick="submitRegister()">âœ… ØªØ³Ø¬ÙŠÙ„</button>
â€  <button onclick="backToLogin()">â¬… Ø±Ø¬ÙˆØ¹</button>
â€</div>

â€<!-- APP -->
â€<div class="box hidden" id="appBox">
â€  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
â€  <h4>ğŸ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>
â€<button onclick="openMyBets()" style="margin-top:10px">
  ğŸ« ØªÙƒÙ‡Ù†Ø§ØªÙŠ
â€</button>
â€  <h3>âš½ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
â€  <div id="matchesBox"></div>
â€</div>
â€<!-- MY BETS -->
â€<div class="box hidden" id="myBetsBox">
â€  <h3>ğŸ« ØªÙƒÙ‡Ù†Ø§ØªÙŠ</h3>

â€  <div id="myBetsList">
    <!-- Ø§Ù„ØªÙƒÙ‡Ù†Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
â€  </div>

â€  <button onclick="backToMatches()" style="margin-top:10px">
    â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹
â€  </button>
â€</div>
â€<script type="module">
â€/* ================= IMPORTS ================= */
â€import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
â€import {
â€  getAuth,
â€  createUserWithEmailAndPassword,
â€  signInWithEmailAndPassword,
â€  onAuthStateChanged,
â€  signOut
â€} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
â€import {
â€  getFirestore,
â€  doc,
â€  setDoc,
â€  getDoc,
â€  updateDoc,
â€  collection,
â€  query,
â€  where,
â€  serverTimestamp,
â€  getDocs
â€} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

â€/* ================= FIREBASE ================= */
â€const firebaseConfig = {
â€  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
â€  authDomain: "maliapp-63f91.firebaseapp.com",
â€  projectId: "maliapp-63f91"
};

â€const app = initializeApp(firebaseConfig);
â€const auth = getAuth(app);
â€const db = getFirestore(app);
â€async function getMatchesMap(){
â€  const map = {};
â€  const snap = await getDocs(collection(db,"matches"));

â€  snap.forEach(docu=>{
â€    map[docu.id] = docu.data();
  });

â€  return map;
}
â€/* ================= GLOBAL ================= */
â€let userData = {};
â€let matches = [];

â€/* ================= LEVELS ================= */
â€const LEVELS = {
â€  1: { reward: 0.5 },
â€  2: { reward: 1.5 },
â€  3: { reward: 3 }
};

â€/* ================= UI ================= */
â€function updateUI(){
â€  balance.innerText = userData.balance ?? 0;
â€  level.innerText = userData.level ?? 1;
}

â€/* ================= AUTH ================= */
â€window.openRegister = ()=>{
â€  authBox.classList.add("hidden");
â€  registerBox.classList.remove("hidden");
};

â€window.backToLogin = ()=>{
â€  registerBox.classList.add("hidden");
â€  authBox.classList.remove("hidden");
};

â€window.submitRegister = async ()=>{
â€  const email = regEmail.value.trim();
â€  const phone = regPhone.value.trim();
â€  const pass = regPassword.value;
â€  const confirm = regConfirm.value;

â€  if(!email || !phone || !pass || pass !== confirm){
â€    alert("âŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
â€    return;
  }

â€  const cred = await createUserWithEmailAndPassword(auth,email,pass);

â€  await setDoc(doc(db,"users",cred.user.uid),{
â€    email,
â€    phone,
â€    balance: 1000,
â€    level: 1,
â€    createdAt: serverTimestamp()
  });

â€  registerBox.classList.add("hidden");
â€  appBox.classList.remove("hidden");
};

â€window.login = async ()=>{
â€  await signInWithEmailAndPassword(auth,email.value,password.value);
};

â€/* ================= AUTH STATE ================= */
â€onAuthStateChanged(auth, async(user)=>{
â€  if(!user){
â€    authBox.classList.remove("hidden");
â€    appBox.classList.add("hidden");
â€    return;
  }

â€  const snap = await getDoc(doc(db,"users",user.uid));
â€  userData = snap.data();

â€  authBox.classList.add("hidden");
â€  appBox.classList.remove("hidden");

â€  updateUI();
â€  await fetchMatches();
});
â€window.openMyBets = ()=>{
â€  appBox.classList.add("hidden");
â€  myBetsBox.classList.remove("hidden");

  // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ù‡Ù†Ø§
â€  const myBetsList = document.getElementById("myBetsList");
â€  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

â€  loadMyBets();
};

â€ async function loadMyBets(){
â€  const myBetsList = document.getElementById("myBetsList");
â€  const user = auth.currentUser;

â€  if(!user){
â€    myBetsList.innerHTML = "âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
â€    return;
  }

â€  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

â€  const matchesMap = await getMatchesMap();

â€  const q = query(
â€    collection(db,"bets"),
â€    where("userId","==",user.uid)
  );

â€  const snap = await getDocs(q);

â€  if(snap.empty){
â€    myBetsList.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒÙ‡Ù†Ø§Øª";
â€    return;
  }

â€  myBetsList.innerHTML = "";

â€  snap.forEach(docu=>{
â€    const b = docu.data();
â€    const match = matchesMap[b.matchId];

â€    let statusClass = "bet-pending";
â€    let statusText  = "â³ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†ØªØ¸Ø§Ø±";

â€    if(match?.result){
â€      if(b.choice === match.result){
â€        statusClass = "bet-win";
â€        statusText  = "âœ… Ø±Ø¨Ø­Øª";
â€      }else{
â€        statusClass = "bet-lose";
â€        statusText  = "âŒ Ø®Ø³Ø±Øª";
      }
    }

â€    myBetsList.innerHTML += `
â€      <div class="match-card">
â€        <div style="display:flex;justify-content:space-between">
â€          <strong>${match?.teamA ?? "ØŸ"} ğŸ†š ${match?.teamB ?? "ØŸ"}</strong>
â€          <span class="badge ${statusClass}">
â€            ${statusText}
â€          </span>
â€        </div>

â€        <div style="margin-top:8px">
          ğŸ¯ Ø§Ø®ØªÙŠØ§Ø±Ùƒ:
â€          <strong style="font-size:18px">${b.choice}</strong>
â€        </div>

â€        <div class="bet-status ${statusClass}">
          ğŸ Ø§Ù„Ù†ØªÙŠØ¬Ø©:
â€          ${match?.result ?? "Ù„Ù… ØªÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯"}
â€        </div>
â€      </div>
    `;
  });
}
â€/* ================= MATCHES ================= */
â€async function fetchMatches(){
â€  matchesBox.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª...";
â€  matches = [];

â€  const q = query(collection(db,"matches"));
â€  const snap = await getDocs(q);

â€  snap.forEach(docu=>{
â€    const d = docu.data();
â€    matches.push({
â€      id: docu.id,
â€      teamA: d.teamA,
â€      teamB: d.teamB,
â€      startTime: d.startTime.toDate(),
â€      endTime: d.endTime.toDate(),
â€      result: d.result ?? null,
â€      settled: d.settled ?? false
    });
  });

â€  loadMatches(); 
}
â€function loadMatches(){
â€  matchesBox.innerHTML = "";

â€  if(matches.length === 0){
â€    matchesBox.innerHTML = "<p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª</p>";
â€    return;
  }

â€  const now = new Date();

â€  matches.forEach(m=>{
â€    const canBet = now < m.startTime;

â€    matchesBox.innerHTML += `
â€      <div class="match-card">
â€        <div class="match-header">
â€          <div class="team">
â€            <i class="fa-solid fa-shield"></i>
â€            ${m.teamA}
â€          </div>

â€          <span class="vs">VS</span>

â€          <div class="team">
â€            <i class="fa-solid fa-shield"></i>
â€            ${m.teamB}
â€          </div>
â€        </div>

â€        <div class="match-time">
â€          ğŸ•’ ${m.startTime.toLocaleString()}
â€        </div>

â€        <div class="bet-buttons">
â€   <button class="bet-btn"
â€        data-id="${m.id}"
â€        data-choice="1"
â€        onclick="placeBet('${m.id}','1', this)">
  1
â€</button>

â€<button class="bet-btn"
â€        data-id="${m.id}"
â€        data-choice="X"
â€        onclick="placeBet('${m.id}','X', this)">
â€  X
â€</button>

â€<button class="bet-btn"
â€        data-id="${m.id}"
â€        data-choice="2"
â€        onclick="placeBet('${m.id}','2', this)">
  2
â€</button>
â€        </div>
â€      </div>
    `;
  });
 
}

â€/* ================= BET ================= */
â€window.placeBet = async (matchId, choice, btn)=>{
â€  try{
â€    const user = auth.currentUser;

    // ğŸ” Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø·
â€    console.log("USER:", user?.uid);

â€    if(!user){
â€      alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
â€      return;
    }

â€    const betRef = doc(db,"bets",`${user.uid}_${matchId}`);
â€    const snap = await getDoc(betRef);

â€    if(snap.exists()){
â€      alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙƒÙ‡Ù†");
â€      return;
    }

â€    await setDoc(betRef,{
â€      userId: user.uid,
â€      matchId,
â€      choice,
â€      settled: false,
â€      createdAt: serverTimestamp()
    });

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø²Ø±
â€    btn.classList.add("selected");

    // ØªØ¹Ø·ÙŠÙ„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
â€    btn.parentElement.querySelectorAll(".bet-btn").forEach(b=>{
â€      b.disabled = true;
    });

â€    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙƒÙ‡Ù†: " + choice);

â€  }catch(e){
â€    console.error("FIRESTORE ERROR ğŸ‘‰", e);
â€    alert(e.message);
  }
};

â€/* ================= SETTLE MATCH ================= */
â€async function settleMatch(match){
â€  const betsQ = query(
â€    collection(db,"bets"),
â€    where("matchId","==",match.id),
â€    where("settled","==",false)
  );

â€  const betsSnap = await getDocs(betsQ);

â€  for(const betDoc of betsSnap.docs){
â€    const bet = betDoc.data();

â€    if(bet.choice === match.result){
â€      const userRef = doc(db,"users",bet.userId);
â€      const userSnap = await getDoc(userRef);

â€      if(userSnap.exists()){
â€        const lvl = userSnap.data().level || 1;
â€        const reward = LEVELS[lvl].reward;

â€        await updateDoc(userRef,{
â€          balance: (userSnap.data().balance || 0) + reward
        });
      }
    }

â€    await updateDoc(betDoc.ref,{ settled:true });
  }

â€  await updateDoc(doc(db,"matches",match.id),{ settled:true });
â€  console.log("âœ… ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:",match.id);
}

â€/* ================= LOGOUT ================= */
â€window.logout = async ()=>{
â€  await signOut(auth);
â€  location.reload();
};
â€  window.backToMatches = ()=>{
â€  myBetsBox.classList.add("hidden");
â€  appBox.classList.remove("hidden");
};
â€</script>

â€</body>
â€</html>
