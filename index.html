<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.box{
  max-width:420px;
  margin:25px auto;
  background:#111;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
button{
  background:#00c853;
  font-weight:bold;
  cursor:pointer;
}
.task{
  background:#222;
  padding:10px;
  border-radius:8px;
  margin:6px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.history-card{
  background:#1c1c1c;
  padding:12px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  animation:fade .3s;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
}
.pending{background:#ff9800}
.approved{background:#00c853}
.rejected{background:#d50000}
.level-card{
  background:#1c1c1c;
  padding:15px;
  border-radius:12px;
  margin:10px 0;
}
.back-btn{
  background:#444;
}
@keyframes fade{from{opacity:0}to{opacity:1}}
</style>
</head>

<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- APP -->
<div class="box" id="appBox" style="display:none">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

  <button onclick="openUpgrade()">ğŸš€ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨</button>

  <div id="tasksBox"></div>

  <h3>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</h3>
  <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="requestWithdraw()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>

  <button onclick="openWithdrawHistory()">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</button>
</div>

<!-- WITHDRAW HISTORY PAGE -->
<div class="box" id="withdrawPage" style="display:none">
  <h3>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</h3>
  <div id="withdrawHistory"></div>
  <button class="back-btn" onclick="backToApp()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- UPGRADE -->
<div class="box" id="upgradeBox" style="display:none">
  <h3>ğŸš€ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨</h3>

  <div class="level-card">
    <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</h4>
    <p>11 Ù…Ù‡Ù…Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§</p>
    <p>ğŸ’° 230 Ù†Ù‚Ø·Ø©</p>
    <button onclick="upgradeLevel(2)">ØªØ±Ù‚ÙŠØ©</button>
  </div>

  <div class="level-card">
    <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3</h4>
    <p>23 Ù…Ù‡Ù…Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§</p>
    <p>ğŸ’° 590 Ù†Ù‚Ø·Ø©</p>
    <button onclick="upgradeLevel(3)">ØªØ±Ù‚ÙŠØ©</button>
  </div>

  <button class="back-btn" onclick="backToApp()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  addDoc,
  collection,
  query,
  where,
  getDocs,
  serverTimestamp,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData = {};
let currentTask = false;

const LEVELS = {
  1:{tasks:5},
  2:{tasks:11, price:230},
  3:{tasks:23, price:590}
};

/* AUTH */
window.register = async ()=>{
  const cred = await createUserWithEmailAndPassword(auth,email.value,password.value);
  await setDoc(doc(db,"users",cred.user.uid),{
    balance:0,
    level:1,
    tasks:{}
  });
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

onAuthStateChanged(auth, async user=>{
  if(!user) return;
  const snap = await getDoc(doc(db,"users",user.uid));
  userData = snap.data();
  authBox.style.display="none";
  appBox.style.display="block";
  updateUI();
  loadTasks();
});

/* UI */
function updateUI(){
  balance.innerText = userData.balance;
  level.innerText = userData.level;
}

/* TASKS */
function loadTasks(){
  tasksBox.innerHTML="";
  const count = LEVELS[userData.level].tasks;
  for(let i=1;i<=count;i++){
    tasksBox.innerHTML+=`
      <div class="task">
        Ù…Ù‡Ù…Ø© ${i}
        <button onclick="startTask('t${i}',this)">Ø§Ø¨Ø¯Ø£</button>
      </div>`;
  }
}

window.startTask = async (id,btn)=>{
  if(currentTask) return alert("âŒ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°");
  currentTask=true;
  let t=30;
  btn.disabled=true;

  const timer=setInterval(async ()=>{
    btn.innerText=t--;
    if(t<0){
      clearInterval(timer);
      btn.innerText="âœ” ØªÙ…Øª";
      currentTask=false;
      userData.balance+=10;
      userData.tasks[id]=Date.now();
      await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
      updateUI();
    }
  },1000);
};

/* UPGRADE */
window.openUpgrade=()=>{
  appBox.style.display="none";
  upgradeBox.style.display="block";
};

window.upgradeLevel = async (lvl)=>{
  if(userData.level>=lvl) return alert("âŒ Ù„Ø¯ÙŠÙƒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰");
  const price = LEVELS[lvl].price;
  if(userData.balance < price) return alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

  userData.balance -= price;
  userData.level = lvl;

  await updateDoc(doc(db,"users",auth.currentUser.uid),{
    balance:userData.balance,
    level:userData.level
  });

  backToApp();
};

/* WITHDRAW */
window.requestWithdraw = async ()=>{
  const amount = Number(withdrawAmount.value);
  if(amount<=0) return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­");
  if(amount>userData.balance) return alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

  userData.balance -= amount;

  await addDoc(collection(db,"withdrawals"),{
    userId:auth.currentUser.uid,
    email:auth.currentUser.email,
    amount,
    status:"pending",
    createdAt:serverTimestamp()
  });

  await updateDoc(doc(db,"users",auth.currentUser.uid),{
    balance:userData.balance
  });

  withdrawAmount.value="";
  updateUI();
  alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨");
};

/* WITHDRAW PAGE */
window.openWithdrawHistory = async ()=>{
  appBox.style.display="none";
  withdrawPage.style.display="block";

  const q=query(
    collection(db,"withdrawals"),
    where("userId","==",auth.currentUser.uid),
    orderBy("createdAt","desc")
  );
  const snap=await getDocs(q);
  withdrawHistory.innerHTML="";

  snap.forEach(d=>{
    const w=d.data();
    let cls="pending", txt="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
    if(w.status==="approved"){cls="approved";txt="ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„";}
    if(w.status==="rejected"){cls="rejected";txt="Ù…Ø±ÙÙˆØ¶";}

    const date=w.createdAt?.toDate().toLocaleString("ar");

    withdrawHistory.innerHTML+=`
      <div class="history-card">
        <div>
          ğŸ’µ ${w.amount}<br>
          <small>${date}</small>
        </div>
        <span class="badge ${cls}">${txt}</span>
      </div>`;
  });
};

window.backToApp=()=>{
  upgradeBox.style.display="none";
  withdrawPage.style.display="none";
  appBox.style.display="block";
  updateUI();
  loadTasks();
};
</script>

</body>
</html>
