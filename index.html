<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body{margin:0;font-family:Arial;background:#111;color:#fff;}
.box{max-width:420px;margin:25px auto;background:#222;border-radius:16px;padding:20px;}
input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;}
button{background:#00c853;font-weight:bold;cursor:pointer;}
.task{background:#333;padding:12px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;}
.hidden{display:none;}
  .match-card{
  background: linear-gradient(145deg,#1e1e1e,#2a2a2a);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.4);
}

.match-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.team{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:bold;
}

.team i{
  font-size:20px;
  color:#00e676;
}

.vs{
  font-size:13px;
  opacity:.7;
}

.match-time{
  font-size:12px;
  background:#111;
  padding:4px 8px;
  border-radius:6px;
  opacity:.8;
}

.bet-buttons{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:10px;
}

.bet-btn{
  background:#111;
  border:1px solid #333;
  border-radius:10px;
  padding:10px;
  font-size:16px;
  font-weight:bold;
  color:#fff;
  transition:.2s;
}

.bet-btn:hover{
  background:#00c853;
  color:#000;
}

.bet-btn:disabled{
  opacity:.4;
  cursor:not-allowed;
}
  .bet-btn.selected{
  background:#00e676;
  color:#000;
}
  .bet-status{
  margin-top:6px;
  font-weight:bold;
  font-size:14px;
}

.bet-win{
  color:#00e676;
}

.bet-lose{
  color:#ff5252;
}

.bet-pending{
  color:#ffc107;
}

.badge{
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
  .section-title{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:18px 0 12px;
  padding-bottom:10px;
  border-bottom:1px solid #2f2f2f;
}

.title-left{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:700;
}

.title-left i{
  color:#00e676;
  font-size:20px;
}

.live-dot{
  font-size:11px;
  font-weight:bold;
  color:#000;
  background:#ff1744;
  padding:4px 8px;
  border-radius:20px;
  animation:pulse 1.5s infinite;
}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,23,68,.6);}
  70%{box-shadow:0 0 0 10px rgba(255,23,68,0);}
  100%{box-shadow:0 0 0 0 rgba(255,23,68,0);}
}
 .pro-time{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  background:#111;
  padding:6px 10px;
  border-radius:10px;
  width:fit-content;
  margin-top:8px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
}

.pro-time i{
  color:#00e676;
  font-size:15px;
}

.time-text{
  opacity:.85;
}

.time-sep{
  opacity:.4;
}

.time-hour{
  font-weight:bold;
  letter-spacing:.5px;
} 
  .back-btn{
  background: linear-gradient(145deg,#1e1e1e,#2b2b2b);
  color:#fff;
  border:1px solid #333;
  border-radius:12px;
  padding:12px 16px;
  font-size:15px;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  cursor:pointer;
  transition:.25s;
}

.back-btn i{
  font-size:16px;
  color:#00e676;
}

.back-btn:hover{
  background:#00e676;
  color:#000;
}

.back-btn:hover i{
  color:#000;
}
  .upgrade-btn{
  background:linear-gradient(135deg,#7c4dff,#651fff);
  border:none;
  padding:12px;
  color:white;
  width:100%;
  border-radius:10px;
  font-weight:bold;
  margin-top:10px;
}

.upgrade-title{
  text-align:center;
  color:#ffd54f;
  margin-bottom:15px;
}

.upgrade-cards{
  display:grid;
  gap:15px;
}

.upgrade-card{
  background:#1e1e2f;
  border-radius:14px;
  padding:15px;
  text-align:center;
  box-shadow:0 0 15px rgba(0,0,0,.4);
}

.upgrade-card h4{
  color:#fff;
}

.upgrade-card button{
  margin-top:10px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

.level-1 button{background:#00c853;color:#000;}
.level-2 button{background:#2979ff;color:#fff;}
.level-3 button{background:#ffab00;color:#000;}
  .level-box{
  display:flex;
  align-items:center;
  gap:14px;
  background:linear-gradient(135deg,#1c1c2b,#222);
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.4);
}

.level-icon{
  font-size:32px;
  background:linear-gradient(135deg,#ffd54f,#ffb300);
  color:#000;
  width:52px;
  height:52px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
}

.level-number{
  font-weight:800;
  font-size:15px;
  letter-spacing:1px;
}

.level-name{
  font-size:13px;
  opacity:.8;
  margin-top:2px;
}

.level-bar{
  height:6px;
  background:#111;
  border-radius:10px;
  overflow:hidden;
  margin-top:6px;
}

.level-bar span{
  display:block;
  height:100%;
  background:linear-gradient(90deg,#00e676,#00c853);
  width:20%;
  transition:.3s;
}
  .level-icon{
  font-size:20px;
  background:linear-gradient(135deg,#ffd54f,#ff9100);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
  .balance-card{
  display:flex;
  align-items:center;
  gap:14px;
  background:linear-gradient(135deg,#1e1e1e,#2b2b2b);
  padding:14px 16px;
  border-radius:16px;
  box-shadow:0 8px 18px rgba(0,0,0,.4);
  margin-bottom:12px;
}

.balance-card i{
  font-size:26px;
  color:#00e676;
}

.balance-info{
  display:flex;
  flex-direction:column;
}

.balance-label{
  font-size:12px;
  opacity:.7;
}

.balance-value{
  font-size:22px;
  font-weight:800;
  letter-spacing:.5px;
}

.balance-value small{
  font-size:12px;
  margin-left:6px;
  opacity:.6;
}
  .topup-btn{
  background:linear-gradient(135deg,#00e676,#00c853);
  border:none;
  padding:12px;
  border-radius:14px;
  font-weight:800;
  font-size:15px;
  color:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  cursor:pointer;
  box-shadow:0 6px 14px rgba(0,230,118,.4);
}
 .topup-card{
  background:#1e1e2f;
  border-radius:18px;
  padding:18px;
  text-align:center;
  box-shadow:0 0 20px rgba(0,0,0,.5);
}

.qr{
  width:180px;
  border-radius:14px;
  margin-bottom:12px;
}

.wallet-address{
  background:#111;
  padding:10px;
  border-radius:10px;
  font-size:13px;
  word-break:break-all;
  margin-bottom:10px;
}

.copy-btn{
  background:#2979ff;
  border:none;
  padding:10px;
  width:100%;
  border-radius:10px;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

.warning{
  font-size:12px;
  color:#ffab00;
  margin-top:10px;
} 
  .bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#111;
  border-top:1px solid #2f2f2f;
  display:flex;
  justify-content:space-around;
  padding:8px 0;
  z-index:999;
}

.nav-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  font-size:11px;
  color:#aaa;
  cursor:pointer;
  transition:.2s;
}

.nav-item i{
  font-size:20px;
  margin-bottom:4px;
}

.nav-item.active{
  color:#00e676;
}

.nav-item.active i{
  color:#00e676;
}
  body{
  padding-bottom:70px;
}
  /* ===== PROFILE ===== */
.profile-header{
  display:flex;
  gap:14px;
  align-items:center;
  margin-bottom:18px;
}

.avatar{
  width:64px;
  height:64px;
  border-radius:50%;
  background:linear-gradient(135deg,#00e676,#00c853);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  color:#000;
}

.profile-info{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.profile-name{
  font-weight:800;
  font-size:17px;
}

.profile-id{
  font-size:12px;
  opacity:.6;
}

.profile-level{
  font-size:13px;
  color:#ffd54f;
  display:flex;
  align-items:center;
  gap:6px;
}

.profile-stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-bottom:18px;
}

.stat{
  background:#1e1e1e;
  border-radius:12px;
  padding:12px;
  text-align:center;
}

.stat-number{
  font-size:18px;
  font-weight:800;
  display:block;
}

.stat-label{
  font-size:11px;
  opacity:.6;
}

.profile-actions{
  display:grid;
  gap:10px;
}

.profile-actions button{
  background:#111;
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  color:#fff;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:10px;
}

.profile-actions button i{
  color:#00e676;
}

.profile-actions .danger{
  background:#2b1111;
  border-color:#ff5252;
}

.profile-actions .danger i{
  color:#ff5252;
}
  .bottom-bar{
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 65px;
  background: #0f172a;
  display: flex;
  justify-content: space-around;
  align-items: center;
  border-top: 1px solid rgba(255,255,255,0.1);
  z-index: 999;
}

.bottom-bar button{
  background: none;
  border: none;
  color: #cbd5f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
}

.bottom-bar i{
  font-size: 20px;
  margin-bottom: 4px;
}

.bottom-bar button:hover{
  color: #38bdf8;
}
  .box{
  padding-bottom: 80px;
}
  .bottom-bar{
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 24px);
  max-width: 500px;
  height: 70px;

  background: rgba(20,20,20,0.85);
  backdrop-filter: blur(12px);
  border-radius: 22px;

  display: flex;
  justify-content: space-around;
  align-items: center;

  box-shadow: 0 15px 40px rgba(0,0,0,0.4);
  z-index: 999;
}

.bottom-bar button{
  background: none;
  border: none;
  color: #aaa;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
  cursor: pointer;
  transition: 0.3s;
}

.bottom-bar button i{
  font-size: 20px;
  margin-bottom: 4px;
}

.bottom-bar button.active{
  color: #f5c26b;
}

.bottom-bar button.active i{
  transform: translateY(-3px);
}

.bottom-bar button:active{
  transform: scale(0.92);
}
</style>
</head>
<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="openRegister()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- REGISTER -->
<div class="box hidden" id="registerBox">
  <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <input id="regEmail" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="regPhone" type="tel" placeholder="ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="regPassword" type="password" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regConfirm" type="password" placeholder="ğŸ”‘ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="submitRegister()">âœ… ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="backToLogin()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
 <div class="balance-card">
  <i class="fa-solid fa-wallet"></i>
  <div class="balance-info">
    <span class="balance-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</span>
    <span class="balance-value">
      <span id="balance">0</span>
      <small>USD</small>
    </span>
  </div>
</div>
 <div class="level-box">
<i class="fa-solid fa-crown level-icon"></i>
  <div class="level-info">
    <div class="level-number">LEVEL <span id="level">1</span></div>
    <div class="level-name" id="levelName">Bronze Member</div>
    <div class="level-bar">
      <span id="levelBar"></span>
    </div>
  </div>
</div>
 
  <button class="topup-btn" onclick="openTopUp()">
  <i class="fa-solid fa-bolt"></i>
  ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
</button>
  
  <button class="upgrade-btn" onclick="openUpgrade()">
  <i class="fa-solid fa-arrow-trend-up"></i>
  ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
</button>

<button onclick="openMyBets()" style="margin-top:10px">
  <i class="fa-solid fa-ticket"></i> Ø±Ù‡Ø§Ù†Ø§ØªÙŠ
</button>
<div class="section-title">
  <div class="title-left">
    <i class="fa-solid fa-futbol"></i>
    <span>Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
  </div>

  <span class="live-dot">LIVE</span>
</div>
  <div id="matchesBox"></div>
</div>
<!-- MY BETS -->
<div class="box hidden" id="myBetsBox">
 <h3>
  <i class="fa-solid fa-ticket"></i> Ø±Ù‡Ø§Ù†Ø§ØªÙŠ
</h3>

  <div id="myBetsList">
    <!-- Ø§Ù„ØªÙƒÙ‡Ù†Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
  </div>

<button onclick="backToMatches()" class="back-btn">
  <i class="fa-solid fa-arrow-left"></i>
  Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
</button>
</div>
 <!-- PROFILE -->
<div class="box hidden" id="profileBox">

  <button onclick="backToMatches()" class="back-btn">
    <i class="fa-solid fa-arrow-left"></i>
    Ø§Ù„Ø¹ÙˆØ¯Ø©
  </button>

  <!-- PROFILE HEADER -->
  <div class="profile-header">
    <div class="avatar">
      <i class="fa-solid fa-user"></i>
    </div>

    <div class="profile-info">
      <div class="profile-name" id="profileName">User</div>
      <div class="profile-id">ID: <span id="profileId">---</span></div>
      <div class="profile-level">
        <i class="fa-solid fa-crown"></i>
        <span id="profileLevel">Bronze Member</span>
      </div>
    </div>
  </div>

  <!-- QUICK STATS -->
  <div class="profile-stats">
    <div class="stat">
      <span class="stat-number" id="statBets">0</span>
      <span class="stat-label">Ø±Ù‡Ø§Ù†Ø§Øª</span>
    </div>
    <div class="stat">
      <span class="stat-number" id="statWins">0</span>
      <span class="stat-label">ÙÙˆØ²</span>
    </div>
    <div class="stat">
      <span class="stat-number" id="statLoss">0</span>
      <span class="stat-label">Ø®Ø³Ø§Ø±Ø©</span>
    </div>
  </div>

  <!-- PROFILE ACTIONS -->
  <div class="profile-actions">
    <button onclick="openTopUp()">
      <i class="fa-solid fa-wallet"></i>
      ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
    </button>

    <button onclick="openUpgrade()">
      <i class="fa-solid fa-arrow-trend-up"></i>
      ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
    </button>

    <button>
      <i class="fa-solid fa-headset"></i>
      Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    </button>

    <button onclick="logout()" class="danger">
      <i class="fa-solid fa-right-from-bracket"></i>
      ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    </button>
  </div>

</div> 
  <div class="box hidden" id="upgradeBox">

  <button onclick="backToMatches()" class="back-btn">
    <i class="fa-solid fa-arrow-left"></i>
    Ø§Ù„Ø¹ÙˆØ¯Ø©
  </button>

  <h3 class="upgrade-title">
    <i class="fa-solid fa-crown"></i>
    ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  </h3>

  <div class="upgrade-cards">

    <!-- LEVEL 1 -->
   <div class="upgrade-card level-1">
  <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</h4>
  <p>Ù…ÙƒØ§ÙØ£Ø© Ø±Ø¨Ø­: <strong>0.5 ğŸ’°</strong></p>
  <button disabled>
    Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
  </button>
</div>

    <!-- LEVEL 2 -->
   <div class="upgrade-card level-2">
  <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</h4>
  <p>Ù…ÙƒØ§ÙØ£Ø© Ø±Ø¨Ø­: <strong>1.5 ğŸ’°</strong></p>
  <button onclick="upgradeLevel(2)">
    Ø§Ù„ØªØ±Ù‚ÙŠØ© â€“ 150$
  </button>
</div>

    <!-- LEVEL 3 -->
   <div class="upgrade-card level-3">
  <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3</h4>
  <p>Ù…ÙƒØ§ÙØ£Ø© Ø±Ø¨Ø­: <strong>3 ğŸ’°</strong></p>
  <button onclick="upgradeLevel(3)">
    Ø§Ù„ØªØ±Ù‚ÙŠØ© â€“ 295$
  </button>
</div>
 </div>
    </div> 
  <div class="box hidden" id="topUpBox">

  <button onclick="backToMatches()" class="back-btn">
    <i class="fa-solid fa-arrow-left"></i>
    Ø§Ù„Ø¹ÙˆØ¯Ø©
  </button>

  <h3 class="upgrade-title">
    <i class="fa-solid fa-wallet"></i>
    ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
  </h3>

  <div class="topup-card">
    <img 
      src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=TE3THEisH6nttHBWtJiKpreaxvPGt5sZVW"
      class="qr"
    >

    <div class="wallet-address">
      TE3THEisH6nttHBWtJiKpreaxvPGt5sZVW
    </div>

    <button onclick="copyAddress()" class="copy-btn">
      <i class="fa-solid fa-copy"></i>
      Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    </button>

    <p class="warning">
      <i class="fa-solid fa-circle-info"></i>
      Ø£Ø±Ø³Ù„ ÙÙ‚Ø· USDT (TRC20) Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    </p>
  </div>
</div>
<div class="bottom-bar">
  <button class="active"
        onclick="openTab(this,'appBox')">
  <i class="fa-solid fa-futbol"></i>
  <span>Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</span>
</button>

<button onclick="openTab(this,'upgradeBox')">
  <i class="fa-solid fa-crown"></i>
  <span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>
</button>

<button onclick="openTab(this,'profileBox')">
  <i class="fa-solid fa-user"></i>
  <span>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span>
</button>

<button onclick="setActiveTab(this); alert('Ù‚Ø±ÙŠØ¨Ù‹Ø§')">
  <i class="fa-solid fa-gift"></i>
  <span>Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</span>
</button>

<button onclick="setActiveTab(this); alert('Ø§Ù„Ø¯Ø¹Ù…')">
  <i class="fa-solid fa-headset"></i>
  <span>Ø§Ù„Ø¯Ø¹Ù…</span>
</button>
</div>
 <!-- BOTTOM BAR -->
<div class="bottom-bar">
  <button onclick="openProfile()">
    <i class="fa-solid fa-user"></i>
    <span>Ø¨Ø±ÙˆÙÙŠÙ„</span>
  </button>

  <button onclick="openUpgrade()">
    <i class="fa-solid fa-crown"></i>
    <span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span>
  </button>

  <button onclick="backToMatches()">
    <i class="fa-solid fa-futbol"></i>
    <span>Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</span>
  </button>
</div> 
<script type="module">
/* ================= IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  query,
  where,
  serverTimestamp,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const LEVEL_REWARDS = {
  1: 0.5,
  2: 1.5,
  3: 3
};
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
async function getMatchesMap(){
  const map = {};
  const snap = await getDocs(collection(db,"matches"));

  snap.forEach(docu=>{
    map[docu.id] = docu.data();
  });

  return map;
}
/* ================= GLOBAL ================= */
let userData = {};
let matches = [];
 function showView(id){
  document.querySelectorAll(".box").forEach(b=>{
    b.classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
} 
  window.openTab = function(btn, viewId){
  setActiveTab(btn);
  showView(viewId);
};
/* ================= LEVELS ================= */
const LEVELS = {
  1: { reward: 0.5 },
  2: { reward: 1.5 },
  3: { reward: 3 }
};

/* ================= UI ================= */
function updateUI(){
  balance.innerText = userData.balance ?? 0;
  updateLevelUI(); // ğŸ‘ˆ Ù…Ù‡Ù…
}
  function updateLevelUI(){
  const lvl = userData.level || 1;

  const names = {
    1: "Bronze Member",
    2: "Silver Member",
    3: "Gold Member",
    4: "Platinum Member"
  };

  const progress = {
    1: "25%",
    2: "50%",
    3: "75%",
    4: "100%"
  };

  level.innerText = lvl;
  levelName.innerText = names[lvl] || "VIP";
  levelBar.style.width = progress[lvl] || "100%";
}

/* ================= AUTH ================= */
window.openRegister = ()=>{
  authBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
};

window.backToLogin = ()=>{
  registerBox.classList.add("hidden");
  authBox.classList.remove("hidden");
};

window.submitRegister = async ()=>{
  const email = regEmail.value.trim();
  const phone = regPhone.value.trim();
  const pass = regPassword.value;
  const confirm = regConfirm.value;

  if(!email || !phone || !pass || pass !== confirm){
    alert("âŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth,email,pass);

  await setDoc(doc(db,"users",cred.user.uid),{
    email,
    phone,
    balance: 1000,
    level: 1,
    createdAt: serverTimestamp()
  });

  registerBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

/* ================= AUTH STATE ================= */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  userData = snap.data();

  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");

  updateUI();
  await fetchMatches();
});
window.openMyBets = ()=>{
  appBox.classList.add("hidden");
  myBetsBox.classList.remove("hidden");

  // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ù‡Ù†Ø§
  const myBetsList = document.getElementById("myBetsList");
  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

  loadMyBets();
};

 async function loadMyBets(){
  const myBetsList = document.getElementById("myBetsList");
  const user = auth.currentUser;

  if(!user){
    myBetsList.innerHTML = "âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
    return;
  }

  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

  const matchesMap = await getMatchesMap();

  const q = query(
    collection(db,"bets"),
    where("userId","==",user.uid)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    myBetsList.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒÙ‡Ù†Ø§Øª";
    return;
  }

  myBetsList.innerHTML = "";

  snap.forEach(docu=>{
    const b = docu.data();
    const match = matchesMap[b.matchId];

    let statusClass = "bet-pending";
    let statusText  = '<i class="fa-solid fa-hourglass-half"></i> Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';

    if(match?.result){
      if(b.choice === match.result){
        statusClass = "bet-win";
       statusText = `<i class="fa-solid fa-trophy"></i> ÙÙˆØ²`;
      }else{
        statusClass = "bet-lose";
        statusText = `<i class="fa-solid fa-circle-xmark"></i> Ø®Ø³Ø§Ø±Ø©`;
      }
    }

    myBetsList.innerHTML += `
      <div class="match-card">
        <div style="display:flex;justify-content:space-between">
          <strong>
  ${match?.teamA ?? "ØŸ"}
  <i class="fa-solid fa-bolt" style="margin:0 6px;color:#00e676"></i>
  ${match?.teamB ?? "ØŸ"}
</strong>
          <span class="badge ${statusClass}">
            ${statusText}
          </span>
        </div>

       <div style="margin-top:8px">
  <i class="fa-solid fa-crosshairs" style="margin-left:6px"></i>
  Ø§Ø®ØªÙŠØ§Ø±Ùƒ:
  <strong style="font-size:18px">${b.choice}</strong>
</div>

        <div class="bet-status ${statusClass}">
  <i class="fa-solid fa-flag-checkered" style="margin-left:6px"></i>
  Ø§Ù„Ù†ØªÙŠØ¬Ø©:
  ${match?.result ?? "Ù„Ù… ØªÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯"}
</div>
<div class="bet-status ${statusClass}">
  <i class="fa-solid fa-coins"></i>
  Ø§Ù„Ø±Ø¨Ø­:
  <strong>
    ${b.choice === match?.result 
      ? `+${LEVEL_REWARDS[userData.level]} ğŸ’°`
      : "0"}
  </strong>
</div>
      </div>
    `;
  });
}
/* ================= MATCHES ================= */
async function fetchMatches(){
  matchesBox.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª...";
  matches = [];

  const q = query(collection(db,"matches"));
  const snap = await getDocs(q);

  snap.forEach(docu=>{
    const d = docu.data();
    matches.push({
      id: docu.id,
      teamA: d.teamA,
      teamB: d.teamB,
      startTime: d.startTime.toDate(),
      endTime: d.endTime.toDate(),
      result: d.result ?? null,
      settled: d.settled ?? false
    });
  });
for(const match of matches){
  if(match.result && match.settled === false){
    await settleMatch(match);
  }
}
  loadMatches(); 
}
function loadMatches(){
  matchesBox.innerHTML = "";

  if(matches.length === 0){
    matchesBox.innerHTML = "<p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª</p>";
    return;
  }

  const now = new Date();

  matches.forEach(m=>{
    const canBet = now < m.startTime;
const isToday =
  new Date().toDateString() === m.startTime.toDateString();
    matchesBox.innerHTML += `
      <div class="match-card">
        <div class="match-header">
          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamA}
          </div>

          <span class="vs">VS</span>

          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamB}
          </div>
        </div>

       <div class="match-time pro-time">
  <i class="fa-solid fa-clock"></i>
  <span class="time-text">
   ${isToday ? "Ø§Ù„ÙŠÙˆÙ…" : m.startTime.toLocaleDateString("ar-TN")}
  </span>
  <span class="time-sep">â€¢</span>
  <span class="time-hour">
    ${m.startTime.toLocaleTimeString("ar-TN", { hour: "2-digit", minute: "2-digit" })}
  </span>
</div>
        <div class="bet-buttons">
   <button class="bet-btn"
        data-id="${m.id}"
        data-choice="1"
        onclick="placeBet('${m.id}','1', this)">
  1
</button>

<button class="bet-btn"
        data-id="${m.id}"
        data-choice="X"
        onclick="placeBet('${m.id}','X', this)">
  X
</button>

<button class="bet-btn"
        data-id="${m.id}"
        data-choice="2"
        onclick="placeBet('${m.id}','2', this)">
  2
</button>
        </div>
      </div>
    `;
  });
 
}

/* ================= BET ================= */
window.placeBet = async (matchId, choice, btn)=>{
  try{
    const user = auth.currentUser;

    // ğŸ” Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø·
    console.log("USER:", user?.uid);

    if(!user){
      alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      return;
    }

    const betRef = doc(db,"bets",`${user.uid}_${matchId}`);
    const snap = await getDoc(betRef);

    if(snap.exists()){
      alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙƒÙ‡Ù†");
      return;
    }

    await setDoc(betRef,{
      userId: user.uid,
      matchId,
      choice,
      settled: false,
      createdAt: serverTimestamp()
    });

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø²Ø±
    btn.classList.add("selected");

    // ØªØ¹Ø·ÙŠÙ„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    btn.parentElement.querySelectorAll(".bet-btn").forEach(b=>{
      b.disabled = true;
    });

    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙƒÙ‡Ù†: " + choice);

  }catch(e){
    console.error("FIRESTORE ERROR ğŸ‘‰", e);
    alert(e.message);
  }
};

/* ================= SETTLE MATCH ================= */
async function settleMatch(match){
  const betsQ = query(
    collection(db,"bets"),
    where("matchId","==",match.id),
    where("settled","==",false)
  );

  const betsSnap = await getDocs(betsQ);

  for(const betDoc of betsSnap.docs){
    const bet = betDoc.data();

    // âœ… Ø¥Ø°Ø§ Ø§Ù„ØªÙƒÙ‡Ù† ØµØ­ÙŠØ­
    if(bet.choice === match.result){
      const userRef = doc(db,"users",bet.userId);
      const userSnap = await getDoc(userRef);

      if(userSnap.exists()){
        const lvl = userSnap.data().level || 1;
        const reward = LEVEL_REWARDS[lvl] || 0.5;

        await updateDoc(userRef,{
          balance: (userSnap.data().balance || 0) + reward
        });
      }
    }

    // ğŸ”’ Ù‚ÙÙ„ Ø§Ù„ØªÙƒÙ‡Ù†
    await updateDoc(betDoc.ref,{
      settled: true
    });
  }

  // ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
  await updateDoc(doc(db,"matches",match.id),{
    settled: true
  });
  console.log("âœ… ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:", match.id);
}
/* ================= LOGOUT ================= */
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};
  window.backToMatches = ()=>{
  showView("appBox");
};
window.openUpgrade = ()=>{
  showView("upgradeBox");
};
  window.openProfile = ()=>{
  appBox.classList.add("hidden");
  profileBox.classList.remove("hidden");
};
const UPGRADE_PRICES = {
  2: 150,
  3: 295,
  4: 590
};

window.upgradeLevel = async function(level){
  const user = auth.currentUser;
  if(!user) return;

  const price = UPGRADE_PRICES[level];
  if(!price) return;

  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);

  if(!snap.exists()) return;

  const data = snap.data();

  if(data.level >= level){
    alert("âš ï¸ Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ø¹Ù„Ù‰ Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰");
    return;
  }

  if((data.balance || 0) < price){
    alert("âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ");
    return;
  }

  await updateDoc(userRef,{
    level: level,
    balance: data.balance - price
  });

  // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
  userData.level = level;
  userData.balance -= price;
  updateUI();

  alert("ğŸš€ ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
  backToMatches();
};
window.openTopUp = ()=>{
  showView("topUpBox");
};

window.copyAddress = ()=>{
  navigator.clipboard.writeText("TE3THEisH6nttHBWtJiKpreaxvPGt5sZVW");
  alert("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");
}; 
 function setActiveTab(btn){
  document.querySelectorAll(".bottom-bar button")
    .forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
} 
</script>

</body>
</html>
