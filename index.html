  <div id="myBetsList">
    <!-- Ø§Ù„ØªÙƒÙ‡Ù†Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
  </div>

  <button onclick="backToMatches()" style="margin-top:10px">
    â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹
  </button>
</div>
<script type="module">
/* ================= IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  query,
  where,
  serverTimestamp,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
async function getMatchesMap(){
  const map = {};
  const snap = await getDocs(collection(db,"matches"));

  snap.forEach(docu=>{
    map[docu.id] = docu.data();
  });

  return map;
}
/* ================= GLOBAL ================= */
let userData = {};
let matches = [];

/* ================= LEVELS ================= */
const LEVELS = {
  1: { reward: 0.5 },
  2: { reward: 1.5 },
  3: { reward: 3 }
};

/* ================= UI ================= */
function updateUI(){
  balance.innerText = userData.balance ?? 0;
  level.innerText = userData.level ?? 1;
}

/* ================= AUTH ================= */
window.openRegister = ()=>{
  authBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
};

window.backToLogin = ()=>{
  registerBox.classList.add("hidden");
  authBox.classList.remove("hidden");
};

window.submitRegister = async ()=>{
  const email = regEmail.value.trim();
  const phone = regPhone.value.trim();
  const pass = regPassword.value;
  const confirm = regConfirm.value;

  if(!email || !phone || !pass || pass !== confirm){
    alert("âŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth,email,pass);

  await setDoc(doc(db,"users",cred.user.uid),{
    email,
    phone,
    balance: 1000,
    level: 1,
    createdAt: serverTimestamp()
  });

  registerBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

/* ================= AUTH STATE ================= */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  userData = snap.data();

  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");

  updateUI();
  await fetchMatches();
});
window.openMyBets = ()=>{
  appBox.classList.add("hidden");
  myBetsBox.classList.remove("hidden");

  // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ù‡Ù†Ø§
  const myBetsList = document.getElementById("myBetsList");
  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

  loadMyBets();
};

 async function loadMyBets(){
  const myBetsList = document.getElementById("myBetsList");
  const user = auth.currentUser;

  if(!user){
    myBetsList.innerHTML = "âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
    return;
  }

  myBetsList.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ ØªÙƒÙ‡Ù†Ø§ØªÙƒ...";

  const matchesMap = await getMatchesMap();

  const q = query(
    collection(db,"bets"),
    where("userId","==",user.uid)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    myBetsList.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒÙ‡Ù†Ø§Øª";
    return;
  }

  myBetsList.innerHTML = "";

  snap.forEach(docu=>{
    const b = docu.data();
    const match = matchesMap[b.matchId];

    let statusClass = "bet-pending";
    let statusText  = "â³ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†ØªØ¸Ø§Ø±";

    if(match?.result){
      if(b.choice === match.result){
        statusClass = "bet-win";
        statusText  = "âœ… Ø±Ø¨Ø­Øª";
      }else{
        statusClass = "bet-lose";
        statusText  = "âŒ Ø®Ø³Ø±Øª";
      }
    }

myBetsList.innerHTML += `
  <div class="match-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong class="teams-line">
        ${match?.teamA ?? "ØŸ"}
        <i class="fa-solid fa-bolt vs-icon"></i>
        ${match?.teamB ?? "ØŸ"}
      </strong>

      <span class="badge ${statusClass}">
        ${statusText}
      </span>
    </div>

    <div style="margin-top:8px">
      <i class="fa-solid fa-crosshairs"></i>
      Ø§Ø®ØªÙŠØ§Ø±Ùƒ:
      <strong style="font-size:18px">${b.choice}</strong>
    </div>

    <div class="bet-status ${statusClass}">
      <i class="fa-solid fa-flag-checkered"></i>
      Ø§Ù„Ù†ØªÙŠØ¬Ø©:
      ${match?.result ?? "Ù„Ù… ØªÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯"}
    </div>
  </div>
`;
/* ================= MATCHES ================= */
async function fetchMatches(){
  matchesBox.innerHTML = "â³ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª...";
  matches = [];

  const q = query(collection(db,"matches"));
  const snap = await getDocs(q);

  snap.forEach(docu=>{
    const d = docu.data();
    matches.push({
      id: docu.id,
      teamA: d.teamA,
      teamB: d.teamB,
      startTime: d.startTime.toDate(),
      endTime: d.endTime.toDate(),
      result: d.result ?? null,
      settled: d.settled ?? false
    });
  });

  loadMatches(); 
}
function loadMatches(){
  matchesBox.innerHTML = "";

  if(matches.length === 0){
    matchesBox.innerHTML = "<p>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª</p>";
    return;
  }

  const now = new Date();

  matches.forEach(m=>{
    const canBet = now < m.startTime;

    matchesBox.innerHTML += `
      <div class="match-card">
        <div class="match-header">
          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamA}
          </div>

          <span class="vs">VS</span>

          <div class="team">
            <i class="fa-solid fa-shield"></i>
            ${m.teamB}
          </div>
        </div>

        <div class="match-time">
          ğŸ•’ ${m.startTime.toLocaleString()}
        </div>

        <div class="bet-buttons">
   <button class="bet-btn"
        data-id="${m.id}"
        data-choice="1"
        onclick="placeBet('${m.id}','1', this)">
  1
</button>

<button class="bet-btn"
        data-id="${m.id}"
        data-choice="X"
        onclick="placeBet('${m.id}','X', this)">
  X
</button>

<button class="bet-btn"
        data-id="${m.id}"
        data-choice="2"
        onclick="placeBet('${m.id}','2', this)">
  2
</button>
        </div>
      </div>
    `;
  });
 
}

/* ================= BET ================= */
window.placeBet = async (matchId, choice, btn)=>{
  try{
    const user = auth.currentUser;

    // ğŸ” Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø·
    console.log("USER:", user?.uid);

    if(!user){
      alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      return;
    }

    const betRef = doc(db,"bets",`${user.uid}_${matchId}`);
    const snap = await getDoc(betRef);

    if(snap.exists()){
      alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙƒÙ‡Ù†");
      return;
    }

    await setDoc(betRef,{
      userId: user.uid,
      matchId,
      choice,
      settled: false,
      createdAt: serverTimestamp()
    });

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø²Ø±
    btn.classList.add("selected");

    // ØªØ¹Ø·ÙŠÙ„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    btn.parentElement.querySelectorAll(".bet-btn").forEach(b=>{
      b.disabled = true;
    });

    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙƒÙ‡Ù†: " + choice);

  }catch(e){
    console.error("FIRESTORE ERROR ğŸ‘‰", e);
    alert(e.message);
  }
};

/* ================= SETTLE MATCH ================= */
async function settleMatch(match){
  const betsQ = query(
    collection(db,"bets"),
    where("matchId","==",match.id),
    where("settled","==",false)
  );

  const betsSnap = await getDocs(betsQ);

  for(const betDoc of betsSnap.docs){
    const bet = betDoc.data();

    if(bet.choice === match.result){
      const userRef = doc(db,"users",bet.userId);
      const userSnap = await getDoc(userRef);

      if(userSnap.exists()){
        const lvl = userSnap.data().level || 1;
        const reward = LEVELS[lvl].reward;

        await updateDoc(userRef,{
          balance: (userSnap.data().balance || 0) + reward
        });
      }
    }

    await updateDoc(betDoc.ref,{ settled:true });
  }

  await updateDoc(doc(db,"matches",match.id),{ settled:true });
  console.log("âœ… ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:",match.id);
}

/* ================= LOGOUT ================= */
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};
  window.backToMatches = ()=>{
  myBetsBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};
</script>

</body>
</html>

