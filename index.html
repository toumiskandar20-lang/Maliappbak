<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ====== تسجيل ======
window.register = async () => {
  const email = emailR.value;
  const pass = passR.value;
  const invite = inviteR.value || null;

  if(pass.length < 6) return alert("كلمة المرور ضعيفة");

  const cred = await createUserWithEmailAndPassword(auth, email, pass);
  const uid = cred.user.uid;

  const referralCode = Math.floor(100000 + Math.random()*900000).toString();

  await setDoc(doc(db,"users",uid),{
    email,
    balance:0,
    level:1,
    referralCode,
    invitedBy: invite,
    tasks:{},
    createdAt: serverTimestamp()
  });

  loadApp();
};

// ====== دخول ======
window.login = async () => {
  await signInWithEmailAndPassword(auth, emailL.value, passL.value);
  loadApp();
};

// ====== تحميل التطبيق ======
async function loadApp(){
  authBox.style.display="none";
  appBox.style.display="block";

  const user = auth.currentUser;
  const snap = await getDoc(doc(db,"users",user.uid));
  const data = snap.data();

  balance.innerText = data.balance;
  ref.innerText = data.referralCode;

  renderTasks(data.tasks || {});
}

// ====== المهام ======
let runningTask = null;

window.startTask = async (id)=>{
  if(runningTask) return alert("هناك مهمة قيد التنفيذ");
  runningTask = id;

  setTimeout(async ()=>{
    const refDoc = doc(db,"users",auth.currentUser.uid);
    await updateDoc(refDoc,{
      balance: +balance.innerText + 10,
      [`tasks.${id}`]: Date.now()
    });
    runningTask = null;
    loadApp();
  },30000);
};

function renderTasks(done){
  tasks.innerHTML="";
  for(let i=1;i<=5;i++){
    const t = done[i];
    const locked = t && Date.now()-t < 86400000;
    tasks.innerHTML+=`
    <div class="task">
      مهمة ${i}
      <button ${locked?"disabled":""} onclick="startTask(${i})">
        ${locked?"تمت":"ابدأ"}
      </button>
    </div>`;
  }
}

// ====== إعدادات ======
window.logout = ()=>signOut(auth).then(()=>location.reload());

</script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.box{background:#fff;padding:20px;margin:20px;border-radius:12px}
input,button{width:100%;padding:10px;margin:6px 0}
button{background:#2575fc;color:#fff;border:none;border-radius:6px}
.task{display:flex;justify-content:space-between;margin:5px 0}
#settings{position:fixed;right:15px;bottom:15px;font-size:30px}
</style>
</head>

<body>

<div class="box" id="authBox">
<h2>MaliApp</h2>
<input id="emailR" placeholder="Email">
<input id="passR" type="password" placeholder="Password">
<input id="inviteR" placeholder="رمز الدعوة (اختياري)">
<button onclick="register()">تسجيل</button>
<hr>
<input id="emailL" placeholder="Email">
<input id="passL" type="password" placeholder="Password">
<button onclick="login()">دخول</button>
</div>

<div class="box" id="appBox" style="display:none">
<h3>رصيدك: <span id="balance">0</span> مالي</h3>
<p>رمز دعوتك: <b id="ref"></b></p>
<div id="tasks"></div>
</div>

<div id="settings" onclick="logout()">⚙️</div>

</body>
</html>
