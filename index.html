<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
let taskRunning = false;

/* ========= ØªØ³Ø¬ÙŠÙ„ ========= */
window.register = async function () {
  const email = emailR.value;
  const pass = passR.value;
  const pass2 = passR2.value;
  const invite = inviteR.value || "none";

  if (pass !== pass2) return alert("âŒ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");

  const res = await createUserWithEmailAndPassword(auth, email, pass);
  currentUser = res.user;

  const inviteCode = Math.random().toString(36).substring(2,8);

  await setDoc(doc(db,"users",currentUser.uid),{
    email,
    balance:0,
    level:1,
    inviteCode,
    invitedBy:invite,
    createdAt:serverTimestamp(),
    tasks:{}
  });

  loadApp();
};

/* ========= Ø¯Ø®ÙˆÙ„ ========= */
window.login = async function () {
  const email = emailL.value;
  const pass = passL.value;
  const res = await signInWithEmailAndPassword(auth,email,pass);
  currentUser = res.user;
  loadApp();
};

/* ========= ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ========= */
async function loadApp(){
  authBox.style.display="none";
  appBox.style.display="block";

  const snap = await getDoc(doc(db,"users",currentUser.uid));
  window.userData = snap.data();

  balance.innerText = userData.balance;
  level.innerText = userData.level;
  inviteLink.innerText = location.origin + "?ref=" + userData.inviteCode;

  renderTasks();
}

/* ========= Ø§Ù„Ù…Ù‡Ø§Ù… ========= */
const tasks = [
  {id:"t1",name:"Ù…Ù‡Ù…Ø© 1",reward:10},
  {id:"t2",name:"Ù…Ù‡Ù…Ø© 2",reward:10},
  {id:"t3",name:"Ù…Ù‡Ù…Ø© 3",reward:10},
  {id:"t4",name:"Ù…Ù‡Ù…Ø© 4",reward:10},
  {id:"t5",name:"Ù…Ù‡Ù…Ø© 5",reward:10}
];

function renderTasks(){
  tasksBox.innerHTML="";
  tasks.forEach(t=>{
    const doneAt = userData.tasks[t.id];
    const locked = doneAt && Date.now()-doneAt < 86400000;

    const btn = document.createElement("button");
    btn.innerText = locked ? "âœ” ØªÙ…Øª" : "Ø§Ø¨Ø¯Ø£ (30 Ø«Ø§Ù†ÙŠØ©)";
    btn.disabled = locked;
    btn.onclick = ()=>startTask(t);

    tasksBox.append(t.name," ",btn,document.createElement("br"));
  });
}

async function startTask(task){
  if(taskRunning) return alert("âš ï¸ ØªÙˆØ¬Ø¯ Ù…Ù‡Ù…Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„");
  taskRunning=true;

  setTimeout(async ()=>{
    userData.balance += task.reward;
    userData.tasks[task.id] = Date.now();

    if(userData.balance >= userData.level*50){
      userData.level++;
    }

    await updateDoc(doc(db,"users",currentUser.uid),userData);
    alert("âœ… ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø©");
    location.reload();
  },30000);
}

/* ========= Ø³Ø­Ø¨ Ø±Ø§ØªØ¨ ÙˆÙ‡Ù…ÙŠ ========= */
window.withdraw = async function(){
  const amount = Number(withdrawAmount.value);
  if(amount>userData.balance) return alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  userData.balance -= amount;
  await updateDoc(doc(db,"users",currentUser.uid),userData);
  alert("ğŸ’¸ ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø±Ø§ØªØ¨");
  location.reload();
};

/* ========= Ø®Ø±ÙˆØ¬ ========= */
window.logout = async function(){
  await signOut(auth);
  location.reload();
};
</script>

<style>
body{font-family:Arial;background:#0f172a;color:#fff}
.box{background:#111827;padding:20px;border-radius:12px;max-width:360px;margin:20px auto}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none}
button{background:#22c55e;color:#000;font-weight:bold}
hr{opacity:.2}
</style>
</head>

<body>

<div class="box" id="authBox">
<h2>MaliApp</h2>

<input id="emailR" placeholder="ğŸ“§ Email">
<input id="passR" type="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<input id="passR2" type="password" placeholder="ğŸ”’ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<input id="inviteR" placeholder="ğŸ”— Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
<button onclick="register()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>

<hr>

<input id="emailL" placeholder="ğŸ“§ Email">
<input id="passL" type="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="box" id="appBox" style="display:none">
<h3>Ø±ØµÙŠØ¯Ùƒ: <span id="balance">0</span> Ù…Ø§Ù„ÙŠ</h3>
<h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

<p>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©:</p>
<p id="inviteLink"></p>

<hr>

<h3>Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</h3>
<div id="tasksBox"></div>

<hr>

<input id="withdrawAmount" placeholder="Ø³Ø­Ø¨ Ø±Ø§ØªØ¨">
<button onclick="withdraw()">Ø³Ø­Ø¨</button>

<hr>
<button onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

</body>
</html>
