<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.box{
  max-width:420px;
  margin:25px auto;
  background:#111;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
button{
  background:#00c853;
  font-weight:bold;
  cursor:pointer;
}
.task,.history-card{
  background:#222;
  padding:10px;
  border-radius:8px;
  margin:6px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
}
.pending{background:#ff9800}
.approved{background:#00c853}
.copy-btn{
  background:#333;
  color:#fff;
  font-size:14px;
}
.note{
  font-size:13px;
  opacity:.8;
  margin-top:10px;
  text-align:center;
}
.hidden{display:none}
</style>
</head>

<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

  <button onclick="openWithdraw()">ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>

  <div id="tasksBox"></div>
</div>

<!-- WITHDRAW PAGE -->
<div class="box hidden" id="withdrawBox">
  <h3>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</h3>

  <label>ğŸ”— Ù…Ø­ÙØ¸ØªÙƒ</label>
  <input id="walletInput" placeholder="Wallet address">
  <button class="copy-btn" onclick="copyWallet()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>

  <label>ğŸ’° Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨</label>
  <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="setMax()">MAX</button>

  <button onclick="submitWithdraw()">âœ… Ù‚Ù… Ø¨Ø£Ù…Ø± Ø§Ù„Ø³Ø­Ø¨</button>

  <h4>ğŸ“œ Historique Ø§Ù„Ø³Ø­Ø¨</h4>
  <div id="withdrawHistory"></div>

  <div class="note">
    Ø¹Ø²ÙŠØ² Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØŒ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨ÙŠÙ† 24 Ø¥Ù„Ù‰ 72 Ø³Ø§Ø¹Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
  </div>

  <button onclick="back()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  updateDoc,
  addDoc,
  collection,
  query,
  where,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData = {};

/* LOGIN */
window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

onAuthStateChanged(auth, async user=>{
  if(!user) return;
  const snap = await getDoc(doc(db,"users",user.uid));
  userData = snap.data();
  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");
  updateUI();
});

/* UI */
function updateUI(){
  balance.innerText = userData.balance;
  level.innerText = userData.level;
}

/* OPEN WITHDRAW */
window.openWithdraw = async ()=>{
  appBox.classList.add("hidden");
  withdrawBox.classList.remove("hidden");
  walletInput.value = userData.wallet || "";
  loadWithdrawHistory();
};

window.back = ()=>{
  withdrawBox.classList.add("hidden");
  appBox.classList.remove("hidden");
};

/* COPY */
window.copyWallet = ()=>{
  if(!walletInput.value) return alert("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­ÙØ¸Ø©");
  navigator.clipboard.writeText(walletInput.value);
  alert("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­");
};

/* MAX */
window.setMax = ()=>{
  withdrawAmount.value = userData.balance;
};

/* SUBMIT WITHDRAW */
window.submitWithdraw = async ()=>{
  const amount = Number(withdrawAmount.value);
  if(amount<=0) return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­");
  if(amount>userData.balance) return alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

  userData.balance -= amount;
  userData.wallet = walletInput.value;

  await addDoc(collection(db,"withdrawals"),{
    userId:auth.currentUser.uid,
    email:auth.currentUser.email,
    wallet:userData.wallet,
    amount,
    status:"pending",
    createdAt:serverTimestamp()
  });

  await updateDoc(doc(db,"users",auth.currentUser.uid),{
    balance:userData.balance,
    wallet:userData.wallet
  });

  updateUI();
  withdrawAmount.value="";
  loadWithdrawHistory();
};

/* HISTORY */
async function loadWithdrawHistory(){
  const q = query(
    collection(db,"withdrawals"),
    where("userId","==",auth.currentUser.uid)
  );
  const snap = await getDocs(q);
  withdrawHistory.innerHTML="";
  snap.forEach(d=>{
    const w=d.data();
    withdrawHistory.innerHTML+=`
      <div class="history-card">
        <div>${w.amount} ğŸ’µ</div>
        <span class="badge pending">ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
      </div>`;
  });
}
</script>

</body>
</html>
