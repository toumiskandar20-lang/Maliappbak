<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body{margin:0;font-family:Arial;background:#111;color:#fff;}
.box{max-width:420px;margin:25px auto;background:#222;border-radius:16px;padding:20px;}
input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;}
button{background:#00c853;font-weight:bold;cursor:pointer;}
.task{background:#333;padding:12px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;}
.hidden{display:none;}
</style>
</head>
<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="openRegister()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- REGISTER -->
<div class="box hidden" id="registerBox">
  <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <input id="regEmail" type="email" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="regPhone" type="tel" placeholder="ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="regPassword" type="password" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regConfirm" type="password" placeholder="ğŸ”‘ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="submitRegister()">âœ… ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="backToLogin()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>ğŸ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

  <h3>âš½ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
  <div id="matchesBox"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ==================== Firebase Config ====================
const firebaseConfig = {
  apiKey:"AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain:"maliapp-63f91.firebaseapp.com",
  projectId:"maliapp-63f91"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ==================== Ù…ØªØºÙŠØ±Ø§Øª ====================
let userData = {}, userBets = {}, matches = [];

// ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ====================
function updateUI(){
  balance.innerText = userData.balance || 0;
  level.innerText = userData.level || 1;
}

// ==================== ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ====================
window.submitRegister = async () => {
  const email = regEmail.value.trim();
  const phone = regPhone.value.trim();
  const pass = regPassword.value;
  const confirm = regConfirm.value;

  if(!email||!phone||!pass||!confirm) return alert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
  if(pass!==confirm) return alert("âŒ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,"users",cred.user.uid),{
      email, phone, balance:0, level:1, createdAt:serverTimestamp()
    });
    registerBox.classList.add("hidden");
    appBox.classList.remove("hidden");
    await fetchMatches();
  }catch(err){alert("âŒ "+err.message);}
};

// ==================== ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ====================
window.openRegister = ()=>{authBox.classList.add("hidden"); registerBox.classList.remove("hidden");};
window.backToLogin = ()=>{registerBox.classList.add("hidden"); authBox.classList.remove("hidden");};

// ==================== ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ====================
window.login = async ()=> {
  try {
    await signInWithEmailAndPassword(auth,email.value,password.value);
  } catch(err){ alert("âŒ "+err.message); }
};

// ==================== Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====================
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));
  if (!snap.exists()) return alert("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  userData = snap.data();
  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");
  updateUI();
  await fetchMatches();
});

// ==================== Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ====================
async function fetchMatches() {
  matches = [];
  try {
    const q = query(collection(db, "matches"));
    const snap = await getDocs(q);
    snap.forEach(docu => {
      const d = docu.data();
      matches.push({
        id: docu.id,
        teamA: d.teamA,
        teamB: d.teamB,
        startTime: d.startTime.toDate(),
        endTime: d.endTime.toDate(),
        result: d.result || null
      });
    });
    loadMatches();
  } catch (err) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª:", err);
  }
}

// ==================== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ====================
function loadMatches() {
  matchesBox.innerHTML = "";
  const now = new Date();

  matches.forEach(match => {
    const start = new Date(match.startTime);
    const canBet = now < start;
    matchesBox.innerHTML += `
      <div class="task">
        ${match.teamA} ğŸ†š ${match.teamB}
        <br><small>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${start.toLocaleString()}</small>
        <div>
          <button onclick="placeBet('${match.id}', '1')" ${canBet ? '' : 'disabled'}>1</button>
          <button onclick="placeBet('${match.id}', 'X')" ${canBet ? '' : 'disabled'}>X</button>
          <button onclick="placeBet('${match.id}', '2')" ${canBet ? '' : 'disabled'}>2</button>
        </div>
      </div>
    `;
  });
}

// ==================== ÙˆØ¶Ø¹ Ø§Ù„Ø±Ù‡Ø§Ù† ====================
window.placeBet = (matchId, bet)=>{
  const match = matches.find(m => m.id===matchId);
  const now = new Date();
  if(now >= new Date(match.startTime)){ alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙƒÙ‡Ù† Ø¨Ø¹Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©"); return; }
  userBets[matchId] = bet;
  loadMatches();
};
</script>

</body>
</html>
