<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.box{
  max-width:420px;
  margin:25px auto;
  background:#111;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
button{
  background:#00c853;
  font-weight:bold;
  cursor:pointer;
}
.task,.history{
  background:#222;
  padding:12px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
}
.pending{background:#ff9800}
.approved{background:#00c853}
.level-card{
  background:#1c1c1c;
  padding:15px;
  border-radius:12px;
  margin:10px 0;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <button onclick="openRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
</div>

<!-- REGISTER -->
<div class="box" id="registerBox" style="display:none">
  <h2>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
  <input id="regEmail" placeholder="Email">
  <input id="regPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="regPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regConfirm" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="refUid" placeholder="UID ØµØ§Ø­Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="backLogin()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- APP -->
<div class="box" id="appBox" style="display:none">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

  <button onclick="openUpgrade()">ğŸš€ ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ø³ØªÙˆÙ‰</button>

  <div id="tasksBox"></div>

  <h3>ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨</h3>
  <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="requestWithdraw()">Ø³Ø­Ø¨</button>

  <h3>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</h3>
  <div id="withdrawHistory"></div>

  <button onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<!-- UPGRADE -->
<div class="box" id="upgradeBox" style="display:none">
  <h3>ğŸš€ ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h3>

  <div class="level-card">
    <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</h4>
    <p>11 Ù…Ù‡Ù…Ø© / Ø§Ù„ÙŠÙˆÙ…</p>
    <p>230 Ù†Ù‚Ø·Ø©</p>
    <button onclick="upgrade(2)">ØªØ±Ù‚ÙŠØ©</button>
  </div>

  <div class="level-card">
    <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3</h4>
    <p>23 Ù…Ù‡Ù…Ø© / Ø§Ù„ÙŠÙˆÙ…</p>
    <p>590 Ù†Ù‚Ø·Ø©</p>
    <button onclick="upgrade(3)">ØªØ±Ù‚ÙŠØ©</button>
  </div>

  <button onclick="backApp()">â¬… Ø±Ø¬ÙˆØ¹</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain:"maliapp-63f91.firebaseapp.com",
  projectId:"maliapp-63f91"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let userData={};

const LEVELS={
  1:{tasks:5,ref:5},
  2:{tasks:11,price:230,ref:23},
  3:{tasks:23,price:590,ref:34}
};

/* NAV */
window.openRegister=()=>{loginBox.style.display="none";registerBox.style.display="block";}
window.backLogin=()=>{registerBox.style.display="none";loginBox.style.display="block";}

/* REGISTER */
window.register=async()=>{
  if(regPassword.value!==regConfirm.value) return alert("âŒ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");

  const cred=await createUserWithEmailAndPassword(auth,regEmail.value,regPassword.value);
  const ref=refUid.value||null;

  await setDoc(doc(db,"users",cred.user.uid),{
    email:regEmail.value,
    phone:regPhone.value,
    balance:0,
    level:1,
    referrer:ref,
    createdAt:serverTimestamp()
  });

  // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©
  if(ref){
    const refDoc=doc(db,"users",ref);
    const snap=await getDoc(refDoc);
    if(snap.exists()){
      const r=snap.data();
      const bonus=LEVELS[r.level]?.ref||0;
      await updateDoc(refDoc,{balance:(r.balance||0)+bonus});
    }
  }
};

/* LOGIN */
window.login=async()=>{await signInWithEmailAndPassword(auth,loginEmail.value,loginPassword.value);}

onAuthStateChanged(auth,async user=>{
  if(!user) return;
  const snap=await getDoc(doc(db,"users",user.uid));
  userData=snap.data();
  loginBox.style.display="none";
  registerBox.style.display="none";
  appBox.style.display="block";
  refresh();
  loadTasks();
  loadWithdraws();
});

/* UI */
function refresh(){
  balance.innerText=userData.balance;
  level.innerText=userData.level;
}

/* TASKS */
function loadTasks(){
  tasksBox.innerHTML="";
  for(let i=1;i<=LEVELS[userData.level].tasks;i++){
    tasksBox.innerHTML+=`
    <div class="task">
      Ù…Ù‡Ù…Ø© ${i}
      <button onclick="doTask(this)">Ø§Ø¨Ø¯Ø£</button>
    </div>`;
  }
}

window.doTask=async(btn)=>{
  btn.disabled=true;
  setTimeout(async()=>{
    userData.balance+=10;
    await updateDoc(doc(db,"users",auth.currentUser.uid),{balance:userData.balance});
    refresh();
    btn.innerText="âœ”";
  },3000);
};

/* WITHDRAW */
window.requestWithdraw=async()=>{
  const amount=Number(withdrawAmount.value);
  if(amount<=0||amount>userData.balance) return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­");

  userData.balance-=amount;
  await updateDoc(doc(db,"users",auth.currentUser.uid),{balance:userData.balance});

  await addDoc(collection(db,"withdrawals"),{
    userId:auth.currentUser.uid,
    email:auth.currentUser.email,
    amount,
    status:"pending",
    createdAt:serverTimestamp()
  });

  refresh();
  loadWithdraws();
};

/* HISTORY */
async function loadWithdraws(){
  withdrawHistory.innerHTML="";
  const q=query(collection(db,"withdrawals"),where("userId","==",auth.currentUser.uid));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    withdrawHistory.innerHTML+=`
    <div class="history">
      <span>${d.data().amount}</span>
      <span class="badge pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
    </div>`;
  });
}

/* UPGRADE */
window.openUpgrade=()=>{appBox.style.display="none";upgradeBox.style.display="block";}
window.backApp=()=>{upgradeBox.style.display="none";appBox.style.display="block";}

window.upgrade=async(lvl)=>{
  if(userData.level>=lvl) return;
  const price=LEVELS[lvl].price;
  if(userData.balance<price) return alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù");

  userData.balance-=price;
  userData.level=lvl;

  await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
  backApp();
  refresh();
  loadTasks();
};

/* LOGOUT */
window.logout=async()=>{await signOut(auth);location.reload();}
</script>

</body>
</html>
