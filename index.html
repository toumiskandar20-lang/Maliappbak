<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.box{
  max-width:400px;
  margin:20px auto;
  background:#111;
  border-radius:15px;
  padding:20px;
  animation:fade .4s;
}
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
button{
  background:#00c853;
  font-weight:bold;
}
.task{
  background:#222;
  padding:10px;
  border-radius:8px;
  margin:6px 0;
  display:flex;
  justify-content:space-between;
}
.history-card{
  background:#1c1c1c;
  padding:12px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  animation:fade .3s;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
}
.pending{background:#ff9800}
.approved{background:#00c853}
.rejected{background:#d50000}
.settings-btn{
  position:fixed;
  right:20px;
  bottom:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#00c853;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  color:#000;
}
@keyframes fade{from{opacity:0}to{opacity:1}}
</style>
</head>

<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2>ğŸ” MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password (6+)">
  <input id="inviteInput" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- APP -->
<div class="box" id="appBox" style="display:none">
  <h3>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span></h3>
  <h4>â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>
  <p>ğŸ”— ÙƒÙˆØ¯Ùƒ: <b id="inviteCode"></b></p>

  <div class="task">Ù…Ù‡Ù…Ø© 1 <button onclick="startTask('t1',this)">Ø§Ø¨Ø¯Ø£</button></div>
  <div class="task">Ù…Ù‡Ù…Ø© 2 <button onclick="startTask('t2',this)">Ø§Ø¨Ø¯Ø£</button></div>

  <h3>ğŸ’¸ Ø³Ø­Ø¨ Ø±Ø§ØªØ¨</h3>
  <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="requestWithdraw()">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>

  <h3>ğŸ“œ Ø§Ù„Ø³Ø¬Ù„</h3>
  <div id="withdrawHistory"></div>

  <button onclick="openTopup()">â• ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø±ØµÙŠØ¯</button>
</div>

<!-- TOPUP -->
<div class="box" id="topupBox" style="display:none">
  <h3>â• ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø±ØµÙŠØ¯</h3>
  <p>Ø£Ø±Ø³Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ÙØ¸Ø©:</p>
  <input id="walletLink" readonly>
  <button onclick="back()">Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- SETTINGS -->
<div class="box" id="settings" style="display:none">
  <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
  <input id="wallet" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø©">
  <button onclick="saveWallet()">Ø­ÙØ¸</button>
  <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  <button onclick="back()">Ø±Ø¬ÙˆØ¹</button>
</div>

<div class="settings-btn" onclick="openSettings()">
  <i class="fa fa-gear"></i>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userData={}, currentTask=false;

// REGISTER
window.register = async ()=>{
  const e=email.value, p=password.value;
  const invite=inviteInput.value;
  const cred=await createUserWithEmailAndPassword(auth,e,p);
  const uid=cred.user.uid;
  const myInvite=uid.slice(0,6);

  await setDoc(doc(db,"users",uid),{
    balance:0, level:1, tasks:{}, wallet:"",
    inviteCode:myInvite, invitedBy:invite||null
  });

  if(invite){
    const q=query(collection(db,"users"),where("inviteCode","==",invite));
    const snap=await getDocs(q);
    snap.forEach(async d=>{
      await updateDoc(doc(db,"users",d.id),{balance:d.data().balance+20});
    });
  }
};

// LOGIN
window.login = async ()=>{await signInWithEmailAndPassword(auth,email.value,password.value);};

onAuthStateChanged(auth, async user=>{
  if(!user) return;
  const snap=await getDoc(doc(db,"users",user.uid));
  userData=snap.data();
  authBox.style.display="none";
  appBox.style.display="block";
  updateUI(); loadWithdrawHistory();
});

function updateUI(){
  balance.innerText=userData.balance;
  level.innerText=userData.level;
  inviteCode.innerText=userData.inviteCode;
}

// TASK
window.startTask = async (id,btn)=>{
  if(currentTask) return alert("âŒ Ù…Ù‡Ù…Ø© Ø´ØºØ§Ù„Ø©");
  const last=userData.tasks[id];
  if(last && Date.now()-last<86400000) return alert("â³ Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©");

  currentTask=true; btn.disabled=true;
  let t=30;
  const timer=setInterval(async()=>{
    btn.innerText=t--;
    if(t<0){
      clearInterval(timer);
      btn.innerText="âœ” ØªÙ…Øª";
      currentTask=false;
      userData.balance+=10;
      userData.tasks[id]=Date.now();
      if(userData.balance>=50) userData.level=2;
      await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
      updateUI();
    }
  },1000);
};

// WITHDRAW
window.requestWithdraw = async ()=>{
  const a=Number(withdrawAmount.value);
  if(a<=0||a>userData.balance) return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­");
  userData.balance-=a;
  await updateDoc(doc(db,"users",auth.currentUser.uid),{balance:userData.balance});
  await addDoc(collection(db,"withdrawals"),{
    userId:auth.currentUser.uid, amount:a, status:"pending", createdAt:serverTimestamp()
  });
  withdrawAmount.value=""; updateUI(); loadWithdrawHistory();
};

async function loadWithdrawHistory(){
  const q=query(collection(db,"withdrawals"),where("userId","==",auth.currentUser.uid));
  const snap=await getDocs(q);
  withdrawHistory.innerHTML="";
  snap.forEach(d=>{
    const w=d.data();
    withdrawHistory.innerHTML+=`
    <div class="history-card">
      <div><i class="fa fa-money-bill"></i> ${w.amount}</div>
      <span class="badge ${w.status}">${w.status}</span>
    </div>`;
  });
}

// UI
window.openSettings=()=>{appBox.style.display="none";settings.style.display="block";}
window.openTopup=()=>{appBox.style.display="none";topupBox.style.display="block";walletLink.value=userData.wallet;}
window.back=()=>{settings.style.display="none";topupBox.style.display="none";appBox.style.display="block";}
window.saveWallet=async()=>{await updateDoc(doc(db,"users",auth.currentUser.uid),{wallet:wallet.value});alert("ØªÙ…");}
window.logout=async()=>{await signOut(auth);location.reload();}
</script>

</body>
</html>
