<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.box{
  max-width:420px;
  margin:25px auto;
  background:#111;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:none;
}
button{
  background:#00c853;
  font-weight:bold;
  cursor:pointer;
}
.hidden{display:none}
.task,.history-card,.level-card{
  background:#222;
  padding:12px;
  border-radius:10px;
  margin:8px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
}
.pending{background:#fbc02d;color:#000}
.approved{background:#00c853;color:#000}
.rejected{background:#d50000}
.toast{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:#00c853;
  color:#000;
  padding:14px 22px;
  border-radius:30px;
  font-weight:bold;
  display:none;
  z-index:999;
}
i{margin-left:6px}
</style>
</head>

<body>

<!-- AUTH -->
<div class="box" id="authBox">
  <h2><i class="fa-solid fa-lock"></i> MaliApp</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
  <button onclick="openRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
</div>

<!-- REGISTER -->
<div class="box hidden" id="registerBox">
  <h2><i class="fa-solid fa-user-plus"></i> Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <input id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  <input id="regPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input id="regPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regConfirm" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <input id="regInvite" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="submitRegister()">ØªØ³Ø¬ÙŠÙ„</button>
  <button onclick="backToLogin()">Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- APP -->
<div class="box hidden" id="appBox">
  <button onclick="openProfile()"><i class="fa-solid fa-user"></i> Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ</button>
  <h3>Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span> ğŸ’µ</h3>
  <h4>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level">1</span></h4>

  <button onclick="openWithdraw()">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
  <button onclick="openUpgrade()">ØªØ±Ù‚ÙŠØ© Ù…Ø³ØªÙˆÙ‰</button>
  <button onclick="openSettings()">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>

  <h3>Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
  <div id="tasksBox"></div>
</div>

<!-- WITHDRAW -->
<div class="box hidden" id="withdrawBox">
  <h3>Ø·Ù„Ø¨ Ø³Ø­Ø¨</h3>
  <input id="withdrawAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
  <button onclick="submitWithdraw()">ØªÙ†ÙÙŠØ°</button>

  <h4>Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</h4>
  <div id="withdrawHistory"></div>

  <button onclick="back()">Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- PROFILE -->
<div class="box hidden" id="profileBox">
  <h3>Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h3>
  <p>Email: <span id="profileEmail"></span></p>
  <p>Ø§Ù„Ø±ØµÙŠØ¯: <span id="profileBalance"></span></p>
  <p>UID: <span id="profileUID"></span></p>
  <p>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©:</p>
  <small id="inviteLink"></small>
  <button onclick="backFromProfile()">Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- SETTINGS -->
<div class="box hidden" id="settingsBox">
  <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
  <p>Email: <span id="setEmail"></span></p>
  <p>UID: <span id="setUID"></span></p>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  <button onclick="backFromSettings()">Ø±Ø¬ÙˆØ¹</button>
</div>

<div class="toast" id="toast">ğŸ‰ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ MaliApp</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore,doc,setDoc,getDoc,updateDoc,addDoc,collection,query,where,onSnapshot,serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"API_KEY",
  authDomain:"PROJECT.firebaseapp.com",
  projectId:"PROJECT"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let userData={};

const LEVELS={
  1:{tasks:5,reward:10},
  2:{tasks:10,reward:15,price:200}
};

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value);

window.openRegister=()=>{
  authBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
};
window.backToLogin=()=>{
  registerBox.classList.add("hidden");
  authBox.classList.remove("hidden");
};

window.submitRegister=async()=>{
  const cred=await createUserWithEmailAndPassword(auth,regEmail.value,regPassword.value);
  await setDoc(doc(db,"users",cred.user.uid),{
    email:regEmail.value,
    phone:regPhone.value,
    balance:0,
    level:1,
    createdAt:serverTimestamp()
  });
};

onAuthStateChanged(auth,async u=>{
  if(!u)return;
  userData=(await getDoc(doc(db,"users",u.uid))).data();
  authBox.classList.add("hidden");
  registerBox.classList.add("hidden");
  appBox.classList.remove("hidden");
  updateUI();
  loadTasks();
});

function updateUI(){
  balance.innerText=userData.balance;
  level.innerText=userData.level;
}

function loadTasks(){
  tasksBox.innerHTML="";
  for(let i=1;i<=LEVELS[userData.level].tasks;i++){
    tasksBox.innerHTML+=`
      <div class="task">
        Ù…Ù‡Ù…Ø© ${i}
        <button onclick="completeTask()">Ø§Ø¨Ø¯Ø£</button>
      </div>`;
  }
}

window.completeTask=async()=>{
  userData.balance+=LEVELS[userData.level].reward;
  await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
  updateUI();
};

window.openWithdraw=()=>{
  appBox.classList.add("hidden");
  withdrawBox.classList.remove("hidden");
  loadWithdraws();
};

window.submitWithdraw=async()=>{
  const a=Number(withdrawAmount.value);
  if(a<=0||a>userData.balance)return alert("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­");
  userData.balance-=a;
  await addDoc(collection(db,"withdrawals"),{
    userId:auth.currentUser.uid,
    amount:a,
    status:"pending",
    createdAt:serverTimestamp()
  });
  await updateDoc(doc(db,"users",auth.currentUser.uid),userData);
  updateUI();
};

function loadWithdraws(){
  const q=query(collection(db,"withdrawals"),where("userId","==",auth.currentUser.uid));
  onSnapshot(q,s=>{
    withdrawHistory.innerHTML="";
    s.forEach(d=>{
      const w=d.data();
      withdrawHistory.innerHTML+=`
        <div class="history-card">
          ${w.amount} ğŸ’µ
          <span class="badge ${w.status}">${w.status}</span>
        </div>`;
    });
  });
}

window.openProfile=()=>{
  appBox.classList.add("hidden");
  profileBox.classList.remove("hidden");
  profileEmail.innerText=auth.currentUser.email;
  profileBalance.innerText=userData.balance;
  profileUID.innerText=auth.currentUser.uid;
  inviteLink.innerText=location.href+"?ref="+auth.currentUser.uid;
};

window.openSettings=()=>{
  appBox.classList.add("hidden");
  settingsBox.classList.remove("hidden");
  setEmail.innerText=auth.currentUser.email;
  setUID.innerText=auth.currentUser.uid;
};

window.back=()=>{withdrawBox.classList.add("hidden");appBox.classList.remove("hidden");}
window.backFromProfile=()=>{profileBox.classList.add("hidden");appBox.classList.remove("hidden");}
window.backFromSettings=()=>{settingsBox.classList.add("hidden");appBox.classList.remove("hidden");}

window.logout=async()=>{await signOut(auth);location.reload();}
</script>

</body>
</html>
