<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f2027;
  color:#fff;
}
.box{
  max-width:900px;
  margin:30px auto;
  background:#111;
  border-radius:12px;
  padding:20px;
}
.card{
  background:#1c1c1c;
  padding:15px;
  border-radius:10px;
  margin:10px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.approve{background:#00c853;}
.reject{background:#ff5252;}
</style>
</head>

<body>

<div class="box">
  <h2>ğŸ›  Admin Dashboard</h2>
  <div id="withdrawList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, collection, getDocs, doc, updateDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ğŸ” ØªØ­Ù‚Ù‚ Admin
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    document.body.innerHTML="âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().isAdmin !== true){
    document.body.innerHTML="âŒ Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­";
    return;
  }

  loadWithdrawals();
});

// ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨
async function loadWithdrawals(){
  const box = document.getElementById("withdrawList");
  box.innerHTML = "";

  const snap = await getDocs(collection(db,"withdrawals"));
  if(snap.empty){
    box.innerHTML="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
    return;
  }

  snap.forEach(d=>{
    const w = d.data();
    if(w.status !== "pending") return;

    box.innerHTML += `
      <div class="card">
        <div>
          <div>ğŸ“§ ${w.email}</div>
          <div>ğŸ’° ${w.amount}</div>
        </div>
        <div>
          <button class="approve" onclick="approve('${d.id}','${w.userId}',${w.amount})">Ù‚Ø¨ÙˆÙ„</button>
          <button class="reject" onclick="reject('${d.id}')">Ø±ÙØ¶</button>
        </div>
      </div>
    `;
  });
}

// âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨
window.approve = async (withdrawId, userId, amount)=>{
  const userRef = doc(db,"users",userId);
  const userSnap = await getDoc(userRef);

  if(!userSnap.exists()) return alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  const newBalance = userSnap.data().balance - amount;
  if(newBalance < 0) return alert("Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  await updateDoc(userRef,{ balance:newBalance });
  await updateDoc(doc(db,"withdrawals",withdrawId),{ status:"approved" });

  alert("âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨");
  loadWithdrawals();
}

// âŒ Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨
window.reject = async (withdrawId)=>{
  await updateDoc(doc(db,"withdrawals",withdrawId),{ status:"rejected" });
  alert("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨");
  loadWithdrawals();
}
</script>

</body>
</html>
